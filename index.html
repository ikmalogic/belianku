<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKMAL PURCHASE</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- (PERUBAHAN) Font Import (Tetap terpisah) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
    </style>
    
    <!-- (PERUBAHAN BESAR) Konfigurasi Tailwind diganti ke tema iOS/Glass -->
    <script>
    tailwind.config = {
        darkMode: 'class', 
        theme: {
            extend: {
                // (BARU) Menambahkan 'blur' kustom untuk efek kaca yang lebih kuat
                blur: {
                    '4xl': '80px',
                    '5xl': '100px',
                },
                fontFamily: {
                    sans: ['Space Grotesk', 'sans-serif'], 
                },
                // (PERUBAHAN) Palet Warna iOS / GitHub
                colors: {
                    /* Tema Terang (Light Mode) */
                    'notion-bg': '#F3F4F6', // (gray-100)
                    'notion-card': '#FFFFFF', // Warna dasar kartu
                    'notion-border': '#000000', // Warna dasar border (diberi opacity nanti)
                    'notion-text': '#1F2937', // (gray-800)
                    'notion-text-subtle': '#6B7280', // (gray-500)
                    'notion-primary': '#2563EB', // (blue-600)

                    /* (PERUBAHAN BESAR) Tema Gelap (Dark Mode) - Mengikuti Palet Duitr.id */
                    'notion-bg-dark': '#000000', // Latar belakang Hitam Pekat
                    'notion-card-dark': '#161616', // Latar belakang kartu/input abu-abu gelap
                    'notion-border-dark': '#2C2C2C', // Border abu-abu (sedikit lebih terang dari kartu)
                    'notion-text-dark': '#F9FAFB', // Teks putih (gray-50)
                    'notion-text-subtle-dark': '#A1A1AA', // Teks sekunder (zinc-400)
                    'notion-primary-dark': '#A3E635', // Aksen Hijau Limau (lime-400)
                }
            },
        }
    }
    </script>
    
    <!-- (PERUBAHAN) Blok style @apply disesuaikan untuk Glassmorphism -->
    <style type="text/tailwindcss">
        /* Import font sudah dipindah ke atas */
        
        body {
            /* (DIUBAH) Transisi untuk semua elemen kaca */
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* === PERUBAHAN UTAMA UNTUK KARTU TIMBUL (GLASSMORPHISM) === */
        .glass-card {
            /* Default/Light Mode: Semi-transparent white + Blur */
            @apply bg-notion-card/80 border border-notion-border/10 rounded-xl shadow-xl transition-colors duration-300;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* REVISION: Dark Mode Override (Matte Black Doff) */
        html.dark .glass-card {
            /* Background Hitam Doff Solid (100% opacity) */
            background-color: #161616; /* Menggunakan notion-card-dark */
            border-color: #2C2C2C; /* Menggunakan notion-border-dark */
            
            /* Menghapus backdrop filter untuk efek matte */
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }
        
        /* Menggunakan ulang kelas dasar untuk kompatibilitas */
        .compact-card-clickable {
            @apply glass-card;
        }

        /* --- Input fields tetap solid --- */
        .notion-input {
            @apply w-full px-3 py-2 
                   bg-notion-card /* L-Mode solid */
                   dark:bg-notion-card-dark /* D-Mode solid */
                   border border-notion-border/10 /* L-Mode subtle border */
                   dark:border-notion-border-dark /* D-Mode solid border */
                   rounded-lg shadow-sm /* (iOS) Sudut lebih bulat */
                   placeholder-notion-text-subtle dark:placeholder-notion-text-subtle-dark 
                   focus:outline-none focus:ring-2 focus:ring-notion-primary dark:focus:ring-notion-primary-dark 
                   text-notion-text dark:text-notion-text-dark;
        }

        /* Style untuk <option> di dalam <select> saat dark mode */
        html.dark select.notion-input option {
            background-color: #000000; /* (PERBAIKAN) notion-bg-dark (agar pekat) */
            color: #F9FAFB; /* (PERBAIKAN) notion-text-dark */
        }

        /* Bug Autofill (Mode Terang) */
        .notion-input:-webkit-autofill,
        .notion-input:-webkit-autofill:hover,
        .notion-input:-webkit-autofill:focus,
        .notion-input:-webkit-autofill:active {
            -webkit-text-fill-color: #1F2937 !important; /* notion-text */
            -webkit-box-shadow: 0 0 0px 1000px #FFFFFF inset !important; /* notion-card */
            box-shadow: 0 0 0px 1000px #FFFFFF inset !important;
            caret-color: #1F2937 !important;
        }
        
        /* Bug Autofill (Mode Gelap) */
        html.dark .notion-input:-webkit-autofill,
        html.dark .notion-input:-webkit-autofill:hover,
        html.dark .notion-input:-webkit-autofill:focus,
        html.dark .notion-input:-webkit-autofill:active {
            -webkit-text-fill-color: #E6EDF3 !important; /* notion-text-dark */
            -webkit-box-shadow: 0 0 0px 1000px #161616 inset !important; /* (PERBAIKAN) notion-card-dark */
            box-shadow: 0 0 0px 1000px #161616 inset !important;
            caret-color: #E6EDF3 !important;
        }
        
        /* --- Tombol --- */
        .btn {
            @apply px-4 py-2 rounded-lg font-medium text-sm transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-notion-bg-dark;
        }
        .btn-primary {
            /* (DIUBAH) Tombol utama kini pakai warna aksen */
            @apply btn bg-notion-primary text-white 
                   dark:bg-notion-primary-dark dark:text-notion-bg-dark /* (PERBAIKAN) Teks menjadi hitam (notion-bg-dark) di atas bg hijau limau */
                   hover:bg-opacity-90 dark:hover:bg-opacity-90 
                   focus:ring-notion-primary dark:focus:ring-notion-primary-dark;
        }
        .btn-secondary {
            /* (PERUBAHAN BESAR) Tombol sekunder - Menghapus efek kaca */
            @apply btn 
                   bg-notion-card /* L-Mode solid */
                   dark:bg-notion-card-dark /* D-Mode solid */
                   border border-notion-border/10 /* L-Mode subtle border */
                   dark:border-notion-border-dark /* D-Mode solid border */
                   text-notion-text dark:text-notion-text-dark 
                   hover:bg-notion-border/5 dark:hover:bg-notion-border-dark/5 
                   focus:ring-gray-400;
        }
        .btn-danger {
            @apply btn bg-red-600 text-white hover:bg-red-700 focus:ring-red-500;
        }
        .btn-icon {
            /* (DIUBAH) Tombol ikon kini pakai efek kaca */
            @apply p-2 rounded-lg text-notion-text-subtle dark:text-notion-text-subtle-dark
                   hover:bg-notion-border/10 dark:hover:bg-notion-border-dark/10
                   transition-colors duration-200;
        }
        .btn-link {
            @apply text-sm text-notion-primary dark:text-notion-primary-dark hover:underline;
        }
        
        .hidden {
            display: none;
        }

        /* --- Sidebar & Menu --- */
        #sidebar {
             /* Sidebar dan Modal kini menggunakan glass-card untuk konsistensi */
            @apply glass-card shadow-2xl;
            transition-property: transform;
            transition-timing-function: ease-in-out;
            transition-duration: 300ms;
            z-index: 50;
        }
        #sidebar-overlay {
            transition-property: opacity;
            transition-timing-function: ease-in-out;
            transition-duration: 300ms;
            z-index: 40;
        }
        
        .menu-item {
            /* (DIUBAH) Menu item kini lebih transparan */
            @apply block w-full px-4 py-3 rounded-lg text-notion-text dark:text-notion-text-dark 
                   hover:bg-notion-border/10 dark:hover:bg-notion-border-dark/10 
                   font-medium transition-colors text-left;
        }
        .menu-item.active-menu-item {
            /* (DIUBAH) Menu aktif lebih terlihat */
            @apply bg-notion-border/10 dark:bg-notion-border-dark/10 font-semibold;
        }
        
        .manually-opened {
            @apply cursor-pointer;
        }
    </style>
</head>

<body class="bg-notion-bg dark:bg-notion-bg-dark text-notion-text dark:text-notion-text-dark font-sans min-h-screen">

    <!-- === SIDEBAR BARU === -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black opacity-0 hidden"></div>
    <!-- REVISION: Menggunakan glass-card untuk Sidebar -->
    <nav id="sidebar" class="fixed top-0 left-0 h-full w-72 glass-card transform -translate-x-full">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold">Menu</h2>
                <button id="sidebar-close-btn" class="btn-icon">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Konten Sidebar -->
            <ul id="sidebar-menu-list" class="flex-1 space-y-2 overflow-y-auto">
                <li>
                    <button class="menu-item active-menu-item" data-action="my-purchase">
                        My Purchase
                    </button>
                </li>
                <li>
                    <button class="menu-item" data-action="my-subscribe">
                        My Subscribe
                    </button>
                </li>
                <li>
                    <button class="menu-item" data-action="my-password">
                        My Password
                    </button>
                </li>
                <!-- (PERBAIKAN) Menu My Link diubah menjadi My Tools -->
                <li>
                    <button class="menu-item" data-action="my-link">
                        My Tools
                    </button>
                </li>
                <!-- (AKHIR PERBAIKAN) -->
                
                <!-- Tombol Collapsible Card (Toggle) -->
                <li id="card-toggle-wrapper" class="px-4 py-3 flex justify-between items-center border-t border-notion-border dark:border-notion-border-dark mt-2 pt-4">
                    <span class="font-medium text-sm">Tutup Kartu</span>
                    <button id="card-toggle-switch" type="button" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gray-200 dark:bg-gray-700 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:ring-offset-2 dark:focus:ring-offset-notion-card-dark" role="switch" aria-checked="false">
                        <span class="sr-only">Tutup Kartu</span>
                        <span id="card-toggle-handle" class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0"></span>
                    </button>
                </li>
            </ul>

            <!-- Info Pengguna & Logout (PINDAHAN DARI HEADER) -->
            <div id="user-info" class="hidden text-sm pt-4 border-t border-notion-border dark:border-notion-border-dark">
                <span id="user-email" class="text-notion-text-subtle dark:text-notion-text-subtle-dark block font-medium mb-1"></span>
                <button id="logout-btn" class="btn-link">Keluar</button>
            </div>
        </div>
    </nav>
    <!-- === AKHIR SIDEBAR BARU === -->

    <!-- Kontainer Utama -->
    <div class="container mx-auto max-w-3xl p-4 md:p-8">

        <!-- Header -->
        <!-- REVISION: Kelas glass-card, shadow-lg, dan latar belakang transparan/blur dihapus. Background tetap mengikuti body. -->
        <header class="relative flex justify-between items-center mb-6 sticky top-0 z-10 py-4">
            <div class="flex items-center gap-2 sm:gap-4"> <!-- Wrapper BARU -->
                <!-- Tombol Hamburger (BARU) -->
                <button id="sidebar-toggle-btn" class="btn-icon">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
            </div>

            <!-- JUDUL DIPINDAHKAN KE SINI DAN DIPOSISIKAN SECARA ABSOLUTE -->
            <h1 id="page-title" class="text-2xl sm:text-3xl font-bold text-notion-text dark:text-notion-text-dark absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
                IKMAL PURCHASE
            </h1>

            <div class="flex items-center gap-2">
                <!-- === SEARCH BAR BARU === -->
                <div class="relative hidden" id="search-wrapper"> 
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-notion-text-subtle dark:text-notion-text-subtle-dark z-10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </span>
                    <input type="text" id="search-input" placeholder="Cari..." class="relative notion-input w-32 md:w-40 focus:w-48 transition-all duration-300 pl-10 pr-3 py-1.5 text-sm rounded-lg">
                </div>
                <!-- === AKHIR SEARCH BAR === -->

                <!-- (BARU) Tombol Ikon Search -->
                <button id="search-toggle-btn" class="btn-icon" aria-label="Buka pencarian">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </button>

                <!-- Tombol Toggle Mode Gelap/Terang -->
                <button id="theme-toggle" class="btn-icon" aria-label="Toggle dark mode">
                    <svg id="theme-icon-dark" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <svg id="theme-icon-light" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
            </div>
        </header>

        <!-- === KONTROL AUTENTIKASI (BARU) === -->
        <!-- REVISION: Menggunakan glass-card untuk Auth Container -->
        <div id="auth-container" class="max-w-md mx-auto my-10 p-6 glass-card hidden">
            
            <!-- Form Login -->
            <form id="login-form" class="">
                <h2 class="text-xl font-semibold mb-4 text-center">Masuk</h2>
                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="login-email" class="notion-input" required>
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="login-password" class="notion-input" required>
                    </div>
                    <button type="submit" class="btn-primary w-full">Masuk</button>
                </div>
                <p class="text-center text-sm mt-4">
                    Belum punya akun? <button type="button" id="show-register-btn" class="btn-link">Daftar di sini</button>
                </p>
            </form>

            <!-- Form Registrasi -->
            <form id="register-form" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-center">Daftar Akun Baru</h2>
                <div class="space-y-4">
                    <div>
                        <label for="register-email" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="register-email" class="notion-input" required>
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="register-password" class="notion-input" minlength="6" required>
                    </div>
                    <button type="submit" class="btn-primary w-full">Daftar</button>
                </div>
                 <p class="text-center text-sm mt-4">
                    Sudah punya akun? <button type="button" id="show-login-btn" class="btn-link">Masuk di sini</button>
                </p>
            </form>

            <!-- (PERBAIKAN) Pemisah 'ATAU' dan tombol Google Login -->
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                    <div class="w-full border-t border-notion-border dark:border-notion-border-dark"></div>
                </div>
                <div class="relative flex justify-center">
                    <span class="bg-notion-card dark:bg-notion-card-dark px-2 text-sm text-notion-text-subtle dark:text-notion-text-subtle-dark">ATAU</span>
                </div>
            </div>

            <div>
                <button type="button" id="google-login-btn" class="btn-secondary w-full flex items-center justify-center gap-3">
                    <!-- SVG Logo Google -->
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path>
                        <path fill="#FF3D00" d="M6.306 14.691L22.99 21.905L17.509 10.22C15.56 7.903 12.019 6.306 8.327 7.151C5.071 7.892 2.348 10.82 2.022 14.366c-.114 1.251.272 2.493.98 3.491l3.304-3.166z"></path>
                        <path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path>
                        <path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-0.792 2.237-2.231 4.166-4.087 5.574l6.19-5.238C39.999 36.661 44 31.138 44 24c0-1.341-.138-2.65-.389-3.917z"></path>
                    </svg>
                    Masuk dengan Google
                </button>
            </div>
            <!-- (AKHIR PERBAIKAN) -->


            <!-- Opsi Login Anonim -->
            <div class="text-center mt-6 pt-6 border-t border-notion-border dark:border-notion-border-dark">
                <button type="button" id="anonymous-login-btn" class="btn-secondary">Coba sebagai Tamu</button>
                <p class="text-xs text-notion-text-subtle mt-2">(Data hanya tersimpan di perangkat ini)</p>
            </div>

            <!-- Pesan Error Auth -->
            <div id="auth-error" class="text-red-600 text-sm text-center mt-4"></div>
        </div>
        <!-- === AKHIR KONTROL AUTENTIKASI === -->


        <!-- === KONTEN UTAMA APLIKASI (Sekarang dibungkus) === -->
        <div id="main-content" class="hidden">
        
            <!-- (PERBAIKAN) Wrapper Tombol Tambah Produk -->
            <div id="add-product-btn-wrapper" class="mb-6 hidden">
                <button id="add-product-btn" class="btn-primary w-full md:w-auto flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    Tambah Produk Baru
                </button>
            </div>
            
            <!-- (PERBAIKAN BARU) Wrapper Tombol Tambah Link -->
            <div id="add-link-btn-wrapper" class="mb-6 hidden">
                <button id="add-link-btn" class="btn-primary w-full md:w-auto flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.102 1.101"></path></svg>
                    Tambah Tools Baru
                </button>
            </div>

            <!-- (PERBAIKAN BARU) Wrapper Tombol Tambah Password -->
            <div id="add-password-btn-wrapper" class="mb-6 hidden">
                <button id="add-password-btn" class="btn-primary w-full md:w-auto flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    Tambah Password Baru
                </button>
            </div>

            <!-- (PERBAIKAN) Wrapper Konten Produk (untuk show/hide) -->
            <div id="product-content" class="hidden">
                <!-- Status Loading -->
                <div id="loading-state" class="text-center text-notion-text-subtle py-10 hidden">
                    <p>Memuat produk...</p>
                </div>
                
                <!-- Status Kosong -->
                <div id="empty-state" class="text-center text-notion-text-subtle py-10 border-2 border-dashed border-notion-border dark:border-notion-border-dark rounded-lg hidden">
                    <p>Belum ada produk digital yang disimpan.</p>
                    <p class="text-sm">Klik "Tambah Produk Baru" untuk memulai.</p>
                </div>

                <!-- Daftar Produk -->
                <div id="product-list" class="">
                    <!-- Kartu Produk akan dimasukkan di sini oleh JavaScript -->
                </div>
            </div>

            <!-- (PERBAIKAN) Wrapper Konten Password -->
            <div id="password-content" class="hidden">
                <!-- (PERBAIKAN BARU) Konten dinamis untuk password -->
                <!-- Status Loading Password -->
                <div id="loading-state-password" class="text-center text-notion-text-subtle py-10 hidden">
                    <p>Memuat password...</p>
                </div>
                
                <!-- Status Kosong Password -->
                <div id="empty-state-password" class="text-center text-notion-text-subtle py-10 border-2 border-dashed border-notion-border dark:border-notion-border-dark rounded-lg hidden">
                    <p>Belum ada password yang disimpan.</p>
                    <p class="text-sm">Klik "Tambah Password Baru" untuk memulai.</p>
                </div>

                <!-- Daftar Password -->
                <div id="password-list" class="space-y-4">
                    <!-- Kartu Password akan dimasukkan di sini oleh JavaScript -->
                </div>
            </div>
            
            <!-- (PERBAIKAN BARU) Wrapper Konten Link -->
            <div id="link-content" class="hidden">
                <!-- Status Loading Link -->
                <div id="loading-state-link" class="text-center text-notion-text-subtle py-10 hidden">
                    <p>Memuat tools...</p>
                </div>
                
                <!-- Status Kosong Link -->
                <div id="empty-state-link" class="text-center text-notion-text-subtle py-10 border-2 border-dashed border-notion-border dark:border-notion-border-dark rounded-lg hidden">
                    <p>Belum ada tools yang disimpan.</p>
                    <p class="text-sm">Klik "Tambah Link Baru" untuk memulai.</p>
                </div>

                <!-- Daftar Link -->
                <div id="link-list" class="space-y-4">
                    <!-- Kartu Link akan dimasukkan di sini oleh JavaScript -->
                </div>
            </div>

        </div>
        <!-- === AKHIR KONTEN UTAMA APLIKASI === -->


    </div> <!-- Akhir Kontainer Utama -->

    <!-- ====================================================================== -->
    <!-- === MODAL PRODUK === -->
    <!-- ====================================================================== -->
    <div id="form-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
        <!-- REVISION: Menggunakan glass-card untuk Modal -->
        <div class="glass-card rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <form id="product-form" class="p-6 space-y-4">
                
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modal-title" class="text-xl font-semibold">Tambah Produk Baru</h2>
                    <button type="button" id="modal-close-btn" class="btn-icon" aria-label="Tutup modal">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <!-- (BARU) Kontainer Pesan Error Modal -->
                <div id="modal-error" class="hidden text-red-600 text-sm p-3 bg-red-100 dark:bg-red-900 dark:text-red-200 rounded-md"></div>
                
                <input type="hidden" id="product-id">
                
                <!-- (BARU) Tipe Transaksi -->
                <div>
                    <label for="tipeTransaksi" class="block text-sm font-medium mb-1">Tipe Entri</label>
                    <div class="relative">
                        <select id="tipeTransaksi" class="notion-input" required>
                            <option value="" disabled selected>Pilih tipe...</option>
                            <option value="purchase">Purchase (Pembelian)</option>
                            <option value="subscribe">Subscribe (Langganan)</option>
                        </select>
                    </div>
                </div>
                
                <!-- (MODIFIKASI) Wrapper untuk bidang khusus Purchase -->
                <div id="purchase-fields" class="hidden space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Tanggal Beli -->
                        <div>
                            <label for="tanggalBeli" class="block text-sm font-medium mb-1">Tanggal Beli</label>
                            <div class="relative input-wrapper">
                                <input type="date" id="tanggalBeli" class="notion-input pr-10"> <!-- required dihapus, di-handle JS -->
                                <button type="button" class="clear-btn absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                        <!-- Harga Beli -->
                        <div>
                            <label for="hargaBeli" class="block text-sm font-medium mb-1">Harga Beli (IDR)</label>
                            <div class="relative input-wrapper">
                                <input type="number" id="hargaBeli" class="notion-input pr-10" placeholder="Contoh: 150000">
                                <button type="button" class="clear-btn absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- (BARU) Wrapper untuk bidang khusus Subscribe -->
                <div id="subscribe-fields" class="hidden space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Tanggal Mulai Langganan -->
                        <div>
                            <label for="tanggalMulai" class="block text-sm font-medium mb-1">Tanggal Mulai</label>
                            <div class="relative input-wrapper">
                                <input type="date" id="tanggalMulai" class="notion-input pr-10">
                                <button type="button" class="clear-btn absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                        <!-- Harga Langganan -->
                        <div>
                            <label for="hargaLangganan" class="block text-sm font-medium mb-1">Harga Langganan (IDR)</label>
                            <div class="relative input-wrapper">
                                <input type="number" id="hargaLangganan" class="notion-input pr-10" placeholder="Contoh: 50000">
                                <button type="button" class="clear-btn absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Periode Langganan -->
                    <div>
                        <label for="periodeLangganan" class="block text-sm font-medium mb-1">Periode Langganan</label>
                        <select id="periodeLangganan" class="notion-input">
                            <option value="">Pilih Periode...</option>
                            <option value="Bulanan">Bulanan</option>
                            <option value="Tahunan">Tahunan</option>
                            <option value="Lifetime">Lifetime (Sekali Bayar)</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                        <div id="periodeLanggananLainnyaContainer" class="hidden mt-2">
                            <div class="relative input-wrapper">
                                <input type="text" id="periodeLanggananLainnya" class="notion-input pr-10" placeholder="Ketik periode kustom...">
                                <button type="button" class="clear-btn absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nama Produk (TETAP) -->
                <div>
                    <label for="namaProduk" class="block text-sm font-medium mb-1">Nama Produk</label>
                    <div class="relative input-wrapper">
                        <input type="text" id="namaProduk" class="notion-input pr-10" required>
                        <button type="button" class="clear-btn absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                
                <!-- === FITUR GEMINI BARU === -->
                <div id="gemini-feature-container" class="hidden space-y-3 pt-2">
                    <button type="button" id="gemini-info-btn" class="btn-secondary w-full flex items-center justify-center gap-2 text-sm">
                        ✨ Dapatkan Info Bermanfaat
                    </button>
                    <div id="gemini-loading" class="hidden text-center text-notion-text-subtle text-sm p-3">
                        <p>Menghubungi AI... (ini mungkin perlu beberapa detik)</p>
                    </div>
                    <div id="gemini-response-container" class="hidden text-sm p-4 bg-notion-border dark:bg-notion-border-dark rounded-md space-y-2">
                        <!-- Respons Gemini akan dimasukkan di sini -->
                    </div>
                </div>
                <!-- === AKHIR FITUR GEMINI === -->
                
                <!-- Owner Produk -->
                <div>
                    <label for="ownerProduk" class="block text-sm font-medium mb-1">Owner/Author Produk</label>
                    <div class="relative input-wrapper">
                        <input type="text" id="ownerProduk" class="notion-input pr-10" placeholder="Nama pembuat/penjual">
                        <button type="button" class="clear-btn absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                                
                <!-- Email -->
                <div>
                    <label for="emailSelect" class="block text-sm font-medium mb-1">Email yang dipakai</label>
                    <select id="emailSelect" class="notion-input">
                        <option value="">Pilih Email...</option>
                        <option value="eunoiamahbara@gmail.com">eunoiamahbara@gmail.com</option>
                        <option value="ikmalogic@gmail.com">ikmalogic@gmail.com</option>
                        <option value="ikmal@fahimna.my.id">ikmal@fahimna.my.id</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                    <div id="emailLainnyaContainer" class="hidden mt-2">
                        <div class="relative input-wrapper">
                            <input type="email" id="emailLainnyaInput" class="notion-input pr-10" placeholder="Ketik email kustom...">
                            <button type="button" class="clear-btn absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Link Akses -->
                <div>
                    <label for="linkAkses" class="block text-sm font-medium mb-1">Link Akses (Satu per baris)</label>
                    <div class="relative input-wrapper">
                        <textarea id="linkAkses" rows="4" class="notion-input pr-10" placeholder="https://link-satu.com&#10;https://link-dua.com&#10;..."></textarea>
                        <button type="button" class="clear-btn absolute top-2.5 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                
                <!-- Tipe Produk -->
                <div>
                    <label for="tipeProduk" class="block text-sm font-medium mb-1">Tipe Produk</label>
                    <select id="tipeProduk" class="notion-input">
                        <option value="">Pilih Tipe...</option>
                        <option value="eBook">eBook</option>
                        <option value="PDF">PDF</option>
                        <option value="Notion">Notion</option>
                        <option value="Kelas / Course">Kelas / Course</option>
                        <option value="CustomGPT">CustomGPT</option>
                        <option value="CustomGEM">CustomGEM</option>
                        <option value="Web App">Web App</option>
                        <option value="Group Telegram">Group Telegram</option>
                        <option value="Group WhatsApp">Group WhatsApp</option>
                        <option value="Webinar">Webinar</option>
                        <option value="Rekaman Video">Rekaman Video</option>
                        <option value="Software/ Aplikasi">Software/ Aplikasi</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                    <div id="tipeProdukLainnyaContainer" class="hidden mt-2">
                        <div class="relative input-wrapper">
                            <input type="text" id="tipeProdukLainnya" class="notion-input pr-10" placeholder="Ketik tipe kustom...">
                            <button type="button" class="clear-btn absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Akun -->
                    <div>
                        <label for="akun" class="block text-sm font-medium mb-1">Akun/Username</label>
                        <div class="relative input-wrapper">
                            <input type="text" id="akun" class="notion-input pr-10" placeholder="username_login">
                            <button type="button" class="clear-btn absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>
                    <!-- Password -->
                    <div>
                        <label for="password" class="block text-sm font-medium mb-1">Password</label>
                        <!-- (MODIFIKASI) Wrapper password kini punya 2 tombol -->
                        <div class="relative input-wrapper">
                            <input type="password" id="password" class="notion-input pr-20" placeholder="••••••••">
                            <!-- (BARU) Tombol Clear 'x', diletakkan di right-10 -->
                            <button type="button" class="clear-btn absolute inset-y-0 right-10 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                            <!-- Tombol Toggle Password, tetap di right-0 -->
                            <button type="button" class="btn-toggle-password absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle" aria-label="Tampilkan password">
                                <svg class="w-5 h-5 toggle-pass-icon-show" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                <svg class="w-5 h-5 toggle-pass-icon-hide hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064 7 9.542 7 .847 0 1.67.129 2.468.375M17.608 14.608A4.986 4.986 0 0017 12a5 5 0 00-5-5 4.986 4.986 0 00-2.608.608M5 5l14 14"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Catatan -->
                <div>
                    <label for="catatan" class="block text-sm font-medium mb-1">Catatan Tambahan</label>
                    <div class="relative input-wrapper">
                        <textarea id="catatan" rows="3" class="notion-input pr-10" placeholder="Info lisensi, kontak support, dll."></textarea>
                        <button type="button" class="clear-btn absolute top-2.5 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="modal-cancel-btn" class="btn-secondary">Batal</button>
                    <button type="submit" id="modal-save-btn" class="btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Konfirmasi Hapus Produk -->
    <div id="confirm-delete-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-60 hidden">
         <!-- REVISION: Menggunakan glass-card untuk Konfirmasi Modal -->
         <div class="glass-card rounded-lg shadow-xl w-full max-w-sm p-6">
            <h3 class="text-lg font-semibold mb-2">Hapus Produk?</h3>
            <p class="text-notion-text-subtle dark:text-notion-text-subtle-dark mb-6">Apakah Anda yakin ingin menghapus produk <strong id="product-name-to-delete"></strong>? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancel-delete-btn" class="btn-secondary">Batal</button>
                <button type="button" id="confirm-delete-btn" class="btn-danger">Ya, Hapus</button>
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- === MODAL LINK (BARU) === -->
    <!-- ====================================================================== -->
    <div id="link-form-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
        <!-- REVISION: Menggunakan glass-card untuk Modal Link -->
        <div class="glass-card rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <form id="link-form" class="p-6 space-y-4">
                
                <div class="flex justify-between items-center mb-4">
                    <h2 id="link-modal-title" class="text-xl font-semibold">Tambah Tools Baru</h2>
                    <button type="button" id="link-modal-close-btn" class="btn-icon" aria-label="Tutup modal">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <div id="link-modal-error" class="hidden text-red-600 text-sm p-3 bg-red-100 dark:bg-red-900 dark:text-red-200 rounded-md"></div>
                
                <input type="hidden" id="link-id">
                
                <div>
                    <label for="link-nama" class="block text-sm font-medium mb-1">Nama Tools/Situs</label>
                    <div class="relative input-wrapper">
                        <input type="text" id="link-nama" class="notion-input pr-10" required placeholder="Contoh: Figma, Google Drive...">
                        <button type="button" class="clear-btn absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label for="link-akses" class="block text-sm font-medium mb-1">Link Akses</label>
                    <div class="relative input-wrapper">
                        <!-- Input URL di modal tetap terlihat penuh -->
                        <input type="url" id="link-akses" class="notion-input pr-10" required placeholder="https://... (masukkan URL lengkap)">
                        <button type="button" class="clear-btn absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                
                <!-- (PERBAIKAN BARU) Kolom Tag -->
                <div>
                    <label for="link-tag" class="block text-sm font-medium mb-1">Tag (pisahkan dengan koma)</label>
                    <div class="relative input-wrapper">
                        <input type="text" id="link-tag" class="notion-input pr-10" placeholder="Contoh: AI, Desain, Produktivitas...">
                        <button type="button" class="clear-btn absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                <!-- (AKHIR PERBAIKAN) -->
                
                <div>
                    <label for="link-catatan" class="block text-sm font-medium mb-1">Catatan</label>
                    <div class="relative input-wrapper">
                        <textarea id="link-catatan" rows="3" class="notion-input pr-10" placeholder="Catatan singkat tentang link ini..."></textarea>
                        <button type="button" class="clear-btn absolute top-2.5 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="link-modal-cancel-btn" class="btn-secondary">Batal</button>
                    <button type="submit" id="link-modal-save-btn" class="btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Konfirmasi Hapus Link (BARU) -->
    <div id="confirm-delete-link-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-60 hidden">
         <!-- REVISION: Menggunakan glass-card untuk Konfirmasi Modal Link -->
         <div class="glass-card rounded-lg shadow-xl w-full max-w-sm p-6">
            <h3 class="text-lg font-semibold mb-2">Hapus Link?</h3>
            <p class="text-notion-text-subtle dark:text-notion-text-subtle-dark mb-6">Apakah Anda yakin ingin menghapus link <strong id="link-name-to-delete"></strong>? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancel-delete-link-btn" class="btn-secondary">Batal</button>
                <button type="button" id="confirm-delete-link-btn" class="btn-danger">Ya, Hapus</button>
            </div>
        </div>
    </div>
    
    <!-- ====================================================================== -->
    <!-- === MODAL PASSWORD (PERBAIKAN BARU) === -->
    <!-- ====================================================================== -->
    <div id="password-form-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
        <!-- REVISION: Menggunakan glass-card untuk Modal Password -->
        <div class="glass-card rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <form id="password-form" class="p-6 space-y-4">
                
                <div class="flex justify-between items-center mb-4">
                    <h2 id="password-modal-title" class="text-xl font-semibold">Tambah Password Baru</h2>
                    <button type="button" id="password-modal-close-btn" class="btn-icon" aria-label="Tutup modal">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <div id="password-modal-error" class="hidden text-red-600 text-sm p-3 bg-red-100 dark:bg-red-900 dark:text-red-200 rounded-md"></div>
                
                <input type="hidden" id="password-id">
                
                <div>
                    <label for="password-nama" class="block text-sm font-medium mb-1">Nama Situs/Layanan</label>
                    <div class="relative input-wrapper">
                        <input type="text" id="password-nama" class="notion-input pr-10" required placeholder="Contoh: Google, Facebook...">
                        <button type="button" class="clear-btn absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label for="password-username" class="block text-sm font-medium mb-1">Email/Username</label>
                    <div class="relative input-wrapper">
                        <input type="text" id="password-username" class="notion-input pr-10" required placeholder="email@contoh.com atau username">
                        <button type="button" class="clear-btn absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>

                <div>
                    <label for="password-password" class="block text-sm font-medium mb-1">Password</label>
                    <div class="relative input-wrapper">
                        <input type="password" id="password-password" class="notion-input pr-20" required placeholder="••••••••">
                        <button type="button" class="clear-btn absolute inset-y-0 right-10 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        <button type="button" class="btn-toggle-password absolute inset-y-0 right-0 px-3 flex items-center text-notion-text-subtle" aria-label="Tampilkan password">
                            <svg class="w-5 h-5 toggle-pass-icon-show" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            <svg class="w-5 h-5 toggle-pass-icon-hide hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064 7 9.542 7 .847 0 1.67.129 2.468.375M17.608 14.608A4.986 4.986 0 0017 12a5 5 0 00-5-5 4.986 4.986 0 00-2.608.608M5 5l14 14"></path></svg>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label for="password-catatan" class="block text-sm font-medium mb-1">Catatan</label>
                    <div class="relative input-wrapper">
                        <textarea id="password-catatan" rows="3" class="notion-input pr-10" placeholder="Catatan singkat tentang akun ini..."></textarea>
                        <button type="button" class="clear-btn absolute top-2.5 right-0 px-3 flex items-center text-notion-text-subtle hidden" aria-label="Hapus isian">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="password-modal-cancel-btn" class="btn-secondary">Batal</button>
                    <button type="submit" id="password-modal-save-btn" class="btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Konfirmasi Hapus Password (PERBAIKAN BARU) -->
    <div id="confirm-delete-password-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-60 hidden">
         <!-- REVISION: Menggunakan glass-card untuk Konfirmasi Modal Password -->
         <div class="glass-card rounded-lg shadow-xl w-full max-w-sm p-6">
            <h3 class="text-lg font-semibold mb-2">Hapus Password?</h3>
            <p class="text-notion-text-subtle dark:text-notion-text-subtle-dark mb-6">Apakah Anda yakin ingin menghapus password untuk <strong id="password-name-to-delete"></strong>? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancel-delete-password-btn" class="btn-secondary">Batal</button>
                <button type="button" id="confirm-delete-password-btn" class="btn-danger">Ya, Hapus</button>
            </div>
        </div>
    </div>
    
    
    <!-- ====================================================================== -->
    <!-- === SCRIPT === -->
    <!-- ====================================================================== -->
    <script type="module">
        // (PERBAIKAN) URL Impor sudah benar
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            GoogleAuthProvider, // (PERBAIKAN) Ditambahkan
            signInWithPopup     // (PERBAIKAN) Ditambahkan
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            setLogLevel, 
            collection, 
            doc, 
            addDoc, 
            setDoc, 
            deleteDoc, 
            onSnapshot, 
            query,
            where,
            getDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. Inisialisasi Firebase ---
        // (Tidak ada perubahan)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let db, auth, userId;
        
        // (PERBAIKAN) Variabel dipisah per fitur
        let unsubscribeFromProducts, unsubscribeFromLinks, unsubscribeFromPasswords;
        let allProducts = [], allLinks = [], allPasswords = []; 
        let productToDeleteId = null, linkToDeleteId = null, passwordToDeleteId = null;
        let currentView = 'my-purchase'; 
        let isCardViewCollapsed = false; 
        
        // --- DOM Elements ---
        // (Tidak ada perubahan)
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const themeIconLight = document.getElementById('theme-icon-light');
        const pageTitle = document.getElementById('page-title');
        
        const authContainer = document.getElementById('auth-container');
        const mainContent = document.getElementById('main-content');
        const userInfo = document.getElementById('user-info');
        const userEmail = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const showLoginBtn = document.getElementById('show-login-btn');
        const anonymousLoginBtn = document.getElementById('anonymous-login-btn');
        const authError = document.getElementById('auth-error');
        
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
        const sidebarMenuList = document.getElementById('sidebar-menu-list'); 
        const cardToggleWrapper = document.getElementById('card-toggle-wrapper');
        
        const searchInput = document.getElementById('search-input');
        const searchToggleBtn = document.getElementById('search-toggle-btn');
        const searchWrapper = document.getElementById('search-wrapper');
        
        // (PERBAIKAN) Elemen DOM baru untuk view
        const addProductBtnWrapper = document.getElementById('add-product-btn-wrapper');
        const productContent = document.getElementById('product-content');
        const passwordContent = document.getElementById('password-content');
        
        // (PERBAIKAN BARU) Elemen DOM untuk "My Link"
        const addLinkBtnWrapper = document.getElementById('add-link-btn-wrapper');
        const linkContent = document.getElementById('link-content');
        const loadingStateLink = document.getElementById('loading-state-link');
        const emptyStateLink = document.getElementById('empty-state-link');
        const linkList = document.getElementById('link-list');
        const addLinkBtn = document.getElementById('add-link-btn');
        
        // (PERBAIKAN BARU) Elemen DOM Modal Link
        const linkFormModal = document.getElementById('link-form-modal');
        const linkForm = document.getElementById('link-form');
        const linkModalTitle = document.getElementById('link-modal-title');
        const linkModalCloseBtn = document.getElementById('link-modal-close-btn');
        const linkModalCancelBtn = document.getElementById('link-modal-cancel-btn');
        const linkModalError = document.getElementById('link-modal-error');
        const confirmDeleteLinkModal = document.getElementById('confirm-delete-link-modal');
        const linkNameToDelete = document.getElementById('link-name-to-delete');
        const cancelDeleteLinkBtn = document.getElementById('cancel-delete-link-btn');
        const confirmDeleteLinkBtn = document.getElementById('confirm-delete-link-btn');
        
        // (PERBAIKAN BARU) Elemen DOM Modal Password
        const addPasswordBtnWrapper = document.getElementById('add-password-btn-wrapper');
        const addPasswordBtn = document.getElementById('add-password-btn');
        const loadingStatePassword = document.getElementById('loading-state-password');
        const emptyStatePassword = document.getElementById('empty-state-password');
        const passwordList = document.getElementById('password-list');
        const passwordFormModal = document.getElementById('password-form-modal');
        const passwordForm = document.getElementById('password-form');
        const passwordModalTitle = document.getElementById('password-modal-title');
        const passwordModalCloseBtn = document.getElementById('password-modal-close-btn');
        const passwordModalCancelBtn = document.getElementById('password-modal-cancel-btn');
        const passwordModalError = document.getElementById('password-modal-error');
        const confirmDeletePasswordModal = document.getElementById('confirm-delete-password-modal');
        const passwordNameToDelete = document.getElementById('password-name-to-delete');
        const cancelDeletePasswordBtn = document.getElementById('cancel-delete-password-btn');
        const confirmDeletePasswordBtn = document.getElementById('confirm-delete-password-btn');

        // Elemen DOM Modal Produk
        const addProductBtn = document.getElementById('add-product-btn');
        const formModal = document.getElementById('form-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const productForm = document.getElementById('product-form');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const productNameToDelete = document.getElementById('product-name-to-delete');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const tipeProdukSelect = document.getElementById('tipeProduk');
        const tipeProdukLainnyaContainer = document.getElementById('tipeProdukLainnyaContainer');
        const tipeProdukLainnyaInput = document.getElementById('tipeProdukLainnya');
        const emailSelect = document.getElementById('emailSelect');
        const emailLainnyaContainer = document.getElementById('emailLainnyaContainer');
        const emailLainnyaInput = document.getElementById('emailLainnyaInput');
        const tipeTransaksiSelect = document.getElementById('tipeTransaksi');
        const purchaseFields = document.getElementById('purchase-fields');
        const subscribeFields = document.getElementById('subscribe-fields');
        const tanggalBeliInput = document.getElementById('tanggalBeli');
        const tanggalMulaiInput = document.getElementById('tanggalMulai');
        const hargaLanggananInput = document.getElementById('hargaLangganan');
        const periodeLanggananSelect = document.getElementById('periodeLangganan');
        const periodeLanggananLainnyaContainer = document.getElementById('periodeLanggananLainnyaContainer');
        const periodeLanggananLainnyaInput = document.getElementById('periodeLanggananLainnya');
        const cardToggleSwitch = document.getElementById('card-toggle-switch');
        const cardToggleHandle = document.getElementById('card-toggle-handle');
        const geminiFeatureContainer = document.getElementById('gemini-feature-container');
        const geminiInfoBtn = document.getElementById('gemini-info-btn');
        const geminiLoading = document.getElementById('gemini-loading');
        const geminiResponseContainer = document.getElementById('gemini-response-container');
        const productList = document.getElementById('product-list');
        const loadingState = document.getElementById('loading-state');
        const emptyState = document.getElementById('empty-state');
        
        // (PERBAIKAN) Elemen DOM baru untuk Google Login
        const googleLoginBtn = document.getElementById('google-login-btn');


        // --- FUNGSI UTAMA APLIKASI ---
        async function initializeAppCore() {
            // (Tidak ada perubahan)
            setLogLevel('Debug');
            let firebaseConfig;
            if (typeof __firebase_config !== 'undefined' && __firebase_config !== "") {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                firebaseConfig = {
                    apiKey: "AIzaSyAaH46INNC6qn5dwVzcvD25juY5Ou9JKUA",
                    authDomain: "beliprodig.firebaseapp.com",
                    projectId: "beliprodig",
                    storageBucket: "beliprodig.firebasestorage.app",
                    messagingSenderId: "898118210057",
                    appId: "1:898118210057:web:d3264a1ea02d9677d7ded8",
                    measurementId: "G-04E1XR3RVD"
                };
            }
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setupAuthListener();
        }


        // --- 2. Logika Mode Gelap/Terang ---
        // (Tidak ada perubahan)
        function applyTheme(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                themeIconLight.classList.remove('hidden');
                themeIconDark.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeIconLight.classList.add('hidden');
                themeIconDark.classList.remove('hidden');
            }
        }
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedTheme = localStorage.getItem('theme');
        let isDarkMode = savedTheme ? savedTheme === 'dark' : prefersDark;
        applyTheme(isDarkMode);
        themeToggle.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            applyTheme(isDarkMode);
        });


        // --- 3. Autentikasi Firebase ---
        
        // (PERBAIKAN) Dihapus pemanggilan loadProducts() ganda
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    showLoggedInUI(user);
                    // loadProducts(); // (DIHAPUS) - Sudah dipanggil di dalam showLoggedInUI
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== "") {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            return; 
                        }
                    } catch (error) {
                        console.error("Login dengan Token Kustom Gagal:", error);
                    }
                    showLoggedOutUI();
                }
            });
        }

        // (PERBAIKAN) Disederhanakan untuk memanggil updateMainView
        function showLoggedInUI(user) {
            authContainer.classList.add('hidden');
            mainContent.classList.remove('hidden');
            userInfo.classList.remove('hidden');   
            if (user.isAnonymous) {
                userEmail.textContent = "Mode Tamu";
            } else {
                userEmail.textContent = user.email;
            }
            
            // Hapus pesan 'coming soon' jika ada
            if (emptyState.innerHTML.includes("My Subscribe")) {
                 emptyState.innerHTML = ''; 
            }
            emptyState.classList.add('hidden');
            
            loadProducts(); // Panggil ini untuk menyiapkan listener data
            loadLinks(); // (PERBAIKAN BARU) Panggil listener data link
            loadPasswords(); // (PERBAIKAN BARU) Panggil listener data password
            
            updateMainView('my-purchase'); // Panggil ini untuk mengatur UI awal
        }

        function showLoggedOutUI() {
            // (PERBAIKAN)
            authContainer.classList.remove('hidden');
            mainContent.classList.add('hidden');
            userInfo.classList.add('hidden');
            authError.textContent = '';
            
            allProducts = [];
            allLinks = []; // (PERBAIKAN BARU)
            allPasswords = []; // (PERBAIKAN BARU)
            
            searchInput.value = '';
            searchWrapper.classList.add('hidden');
            searchToggleBtn.classList.remove('hidden');
            
            if (unsubscribeFromProducts) {
                unsubscribeFromProducts();
                unsubscribeFromProducts = null;
            }
            if (unsubscribeFromLinks) { // (PERBAIKAN BARU)
                unsubscribeFromLinks();
                unsubscribeFromLinks = null;
            }
            if (unsubscribeFromPasswords) { // (PERBAIKAN BARU)
                unsubscribeFromPasswords();
                unsubscribeFromPasswords = null;
            }
            
            productList.innerHTML = '';
            linkList.innerHTML = ''; // (PERBAIKAN BARU)
            passwordList.innerHTML = ''; // (PERBAIKAN BARU)
            
            emptyState.classList.add('hidden');
            emptyStateLink.classList.add('hidden'); // (PERBAIKAN BARU)
            emptyStatePassword.classList.add('hidden'); // (PERBAIKAN BARU)
            
            loadingState.classList.add('hidden');
            loadingStateLink.classList.add('hidden'); // (PERBAIKAN BARU)
            loadingStatePassword.classList.add('hidden'); // (PERBAIKAN BARU)
            
            pageTitle.textContent = "IKMAL PURCHASE";
        }

        async function handleRegister(e) {
            // (Tidak ada perubahan)
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            authError.textContent = '';
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Gagal Daftar:", error.code, error.message);
                if (error.code === 'auth/email-already-in-use') {
                    authError.textContent = 'Email ini sudah terdaftar. Silakan Masuk.';
                } else if (error.code === 'auth/weak-password') {
                    authError.textContent = 'Password terlalu lemah (minimal 6 karakter).';
                } else {
                    authError.textContent = 'Gagal mendaftar. Silakan coba lagi.';
                }
            }
        }

        async function handleLogin(e) {
            // (Tidak ada perubahan)
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Gagal Masuk:", error.code, error.message);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    authError.textContent = 'Email atau password salah.';
                } else {
                    authError.textContent = 'Gagal masuk. Silakan coba lagi.';
                }
            }
        }
        
        // (PERBAIKAN) Fungsi baru untuk Google Login
        async function handleGoogleLogin() {
            authError.textContent = '';
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // Listener onAuthStateChanged akan otomatis menangani
                // perpindahan UI setelah login sukses
            } catch (error) {
                console.error("Gagal Login Google:", error.code, error.message);
                if (error.code === 'auth/popup-closed-by-user') {
                    authError.textContent = 'Login dibatalkan.';
                } else {
                    authError.textContent = 'Gagal masuk dengan Google. Coba lagi.';
                }
            }
        }

        async function handleAnonymousLogin() {
            // (Tidak ada perubahan)
            authError.textContent = '';
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Gagal Login Anonim:", error);
                authError.textContent = 'Gagal login sebagai tamu.';
            }
        }

        async function handleLogout() {
            // (Tidak ada perubahan)
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Gagal Logout:", error);
            }
        }
        
        
        // (PERBAIKAN) Fungsi baru untuk mengelola tampilan
        function updateMainView(newView) {
            // 1. Update status global
            currentView = newView; // Ini penting untuk renderFilteredProducts

            // 2. Update tombol aktif di sidebar
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.toggle('active-menu-item', item.dataset.action === newView);
            });

            // 3. Sembunyikan semua wrapper konten
            productContent.classList.add('hidden');
            passwordContent.classList.add('hidden');
            linkContent.classList.add('hidden'); // (PERBAIKAN BARU)
            addProductBtnWrapper.classList.add('hidden');
            addLinkBtnWrapper.classList.add('hidden'); // (PERBAIKAN BARU)
            addPasswordBtnWrapper.classList.add('hidden'); // (PERBAIKAN BARU)
            
            // 4. Sembunyikan UI header spesifik (search)
            searchToggleBtn.classList.remove('hidden'); // Dipertahankan karena tombol search tidak ada di header sticky
            searchWrapper.classList.add('hidden');
            cardToggleWrapper.classList.add('hidden'); // Sembunyikan toggle kartu
            if (!searchWrapper.classList.contains('hidden')) { // hanya reset jika terbuka
                searchInput.value = '';
            }

            // 5. Tampilkan konten yang relevan
            if (newView === 'my-purchase' || newView === 'my-subscribe') {
                // Ini adalah Tampilan Produk
                pageTitle.textContent = (newView === 'my-purchase') ? "My Purchase" : "My Subscribe";
                productContent.classList.remove('hidden');
                addProductBtnWrapper.classList.remove('hidden');
                searchToggleBtn.classList.remove('hidden');
                cardToggleWrapper.classList.remove('hidden'); // Tampilkan toggle kartu
                
                renderFilteredProducts(); // Panggil render
                
            } else if (newView === 'my-password') {
                // Ini adalah Tampilan Password
                pageTitle.textContent = "My Password";
                passwordContent.classList.remove('hidden');
                addPasswordBtnWrapper.classList.remove('hidden'); // (PERBAIKAN BARU)
                searchToggleBtn.classList.remove('hidden'); // (PERBAIKAN BARU)
                
                renderFilteredPasswords(); // (PERBAIKAN BARU)
                
            } else if (newView === 'my-link') { // (PERBAIKAN BARU)
                // Ini adalah Tampilan Link
                pageTitle.textContent = "My Tools"; // REVISI: Judul diubah menjadi "My Tools"
                linkContent.classList.remove('hidden');
                addLinkBtnWrapper.classList.remove('hidden');
                searchToggleBtn.classList.remove('hidden'); // (PERBAIKAN) Tampilkan search
                
                renderFilteredLinks(); // Panggil render link
            }
        }


        // --- 4. Logika CRUD (Create, Read, Update, Delete) ---
        
        // (PERBAIKAN BESAR KEAMANAN)
        function getCollectionPath(collectionName) {
            if (!userId) {
                console.error("UserID tidak ditemukan, tidak bisa mengakses koleksi.");
                return null;
            }
            // (PERBAIKAN BESAR KEAMANAN)
            // Semua data, baik tamu (anonim) maupun pengguna login (Email/Google),
            // sekarang disimpan di path privat yang terikat pada UserID mereka.
            // Ini menggantikan logika lama yang menggunakan path 'public' untuk pengguna email.
            return `/artifacts/${appId}/users/${userId}/${collectionName}`;
        }
        
        
        // --- 4a. CRUD PRODUK ---
        
        function loadProducts() {
            if (!userId) return;
            const collectionPath = getCollectionPath('products'); // (PERBAIKAN)
            if (!collectionPath) return; 

            loadingState.classList.remove('hidden');
            emptyState.classList.add('hidden');
            productList.innerHTML = '';
            
            if (unsubscribeFromProducts) {
                unsubscribeFromProducts();
            }

            const productsCol = collection(db, collectionPath);
            
            unsubscribeFromProducts = onSnapshot(productsCol, (snapshot) => {
                loadingState.classList.add('hidden');
                
                allProducts = []; // Selalu reset
                snapshot.forEach(doc => {
                    allProducts.push({ id: doc.id, ...doc.data() });
                });

                // (BARU) Buat tanggal utama untuk pengurutan
                allProducts = allProducts.map(p => ({
                    ...p,
                    primaryDate: p.tanggalMulai || p.tanggalBeli || '1970-01-01' 
                }));
                
                // Urutkan *semua* produk berdasarkan tanggal terbaru
                allProducts.sort((a, b) => new Date(b.primaryDate) - new Date(a.primaryDate));
                
                renderFilteredProducts(); // Ini akan me-render ulang setiap ada perubahan data

            }, (error) => {
                console.error("Gagal memuat produk:", error);
                loadingState.textContent = "Gagal memuat data.";
            });
        }
        
        // (BARU) Fungsi untuk membuat kartu ringkas
        function createCompactCard(product) {
            // (Tidak ada perubahan)
            const card = document.createElement('div');
            card.dataset.id = product.id;
            
            // Fungsi utilitas sanitasi
            const sanitize = (str) => {
                if (!str) return '';
                const temp = document.createElement('div');
                temp.textContent = str;
                return temp.innerHTML;
            };

            // REVISION: Menggunakan class 'uppercase' untuk judul
            card.className = "glass-card overflow-hidden p-4 flex justify-between items-center compact-card-clickable cursor-pointer transition-colors hover:bg-notion-border dark:hover:bg-notion-border-dark";
            
            card.innerHTML = `
                <h3 class="text-lg font-bold uppercase">${sanitize(product.namaProduk || 'Tanpa Judul')}</h3>
                <div class="flex-shrink-0">
                    <button class="btn-icon btn-edit" data-id="${product.id}" aria-label="Edit produk">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    </button>
                    <button class="btn-icon btn-delete" data-id="${product.id}" data-name="${sanitize(product.namaProduk || 'ini')}" aria-label="Hapus produk">
                        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `;
            return card;
        }

        // (BARU) Fungsi untuk membuat kartu penuh
        function createFullCard(product) {
            // (Tidak ada perubahan)
            const card = document.createElement('div');
            card.dataset.id = product.id;
            
             // Fungsi utilitas sanitasi
            const sanitize = (str) => {
                if (!str) return '';
                const temp = document.createElement('div');
                temp.textContent = str;
                return temp.innerHTML;
            };

            // REVISION: Menggunakan glass-card
            card.className = "glass-card overflow-hidden";
            
            // Fungsi utilitas format tanggal
            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                try {
                    return new Date(dateString).toLocaleDateString('id-ID', {
                        day: '2-digit', month: 'short', year: 'numeric'
                    });
                } catch (e) {
                    return dateString;
                }
            };
            
            // Fungsi utilitas format mata uang
            const formatCurrency = (number) => {
                if (number === null || number === undefined || number === 0) return 'N/A';
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0
                }).format(number);
            };

            // (MODIFIKASI) Logika Badge & Detail Produk
            let tipeTransaksiHTML = '';
            let productDetailsHTML = '';

            if (product.tipeTransaksi === 'subscribe') {
                // Tampilan untuk "Subscribe"
                tipeTransaksiHTML = `
                    <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-yellow-600 bg-yellow-200 dark:bg-yellow-800 dark:text-yellow-300">
                        Subscribe
                    </span>
                `;
                productDetailsHTML = `
                    <p><strong>Mulai:</strong> ${formatDate(product.tanggalMulai)}</p>
                    <p><strong>Harga:</strong> ${formatCurrency(product.hargaLangganan)} (${sanitize(product.periodeLangganan) || 'N/A'})</p>
                    <p><strong>Email:</strong> ${sanitize(product.email) || 'N/A'}</p>
                `;
            } else {
                // Tampilan default untuk "Purchase" (atau data lama)
                tipeTransaksiHTML = `
                    <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-green-600 bg-green-200 dark:bg-green-800 dark:text-green-300">
                        Purchase
                    </span>
                `;
                productDetailsHTML = `
                    <p><strong>Tgl. Beli:</strong> ${formatDate(product.tanggalBeli)}</p>
                    <p><strong>Harga:</strong> ${formatCurrency(product.hargaBeli)}</p>
                    <p><strong>Email:</strong> ${sanitize(product.email) || 'N/A'}</p>
                `;
            }

            const tipeProdukHTML = product.tipeProduk ? `
                <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200 dark:bg-blue-800 dark:text-blue-300">
                    ${sanitize(product.tipeProduk)}
                </span>
            ` : '';
            
            const ownerHTML = product.ownerProduk ? `<p class="text-sm text-notion-text-subtle dark:text-notion-text-subtle-dark">Oleh: ${sanitize(product.ownerProduk)}</p>` : '';
            
            let linkAksesHTML = '';
            if (Array.isArray(product.linkAkses) && product.linkAkses.length > 0) {
                if (product.linkAkses.length === 1) {
                    linkAksesHTML = `
                        <a href="${sanitize(product.linkAkses[0])}" target="_blank" rel="noopener noreferrer" class="btn-primary inline-flex items-center gap-2">
                            Buka Link Akses
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002 2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        </a>
                    `;
                } else {
                    linkAksesHTML = product.linkAkses.map((link, index) => `
                        <a href="${sanitize(link)}" target="_blank" rel="noopener noreferrer" class="btn-primary inline-flex items-center gap-2">
                            Buka Link ${index + 1}
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002 2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        </a>
                    `).join('');
                }
            } else if (typeof product.linkAkses === 'string' && product.linkAkses.length > 0) {
                linkAksesHTML = `
                    <a href="${sanitize(product.linkAkses)}" target="_blank" rel="noopener noreferrer" class="btn-primary inline-flex items-center gap-2">
                        Buka Link Akses
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002 2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    </a>
                `;
            }
            
            const tombolHTML = linkAksesHTML ? `<div class="pt-2 flex flex-wrap gap-2">${linkAksesHTML}</div>` : '';

            card.innerHTML = `
            <div class="p-4 space-y-3">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="flex flex-wrap gap-2 mb-2">
                            ${tipeTransaksiHTML} <!-- Badge Dinamis -->
                            ${tipeProdukHTML}
                        </div>
                        <h3 class="text-lg font-bold uppercase">${sanitize(product.namaProduk || 'Tanpa Judul')}</h3>
                        ${ownerHTML}
                    </div>
                    <div class="flex-shrink-0">
                        <button class="btn-icon btn-edit" data-id="${product.id}" aria-label="Edit produk">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                        <button class="btn-icon btn-delete" data-id="${product.id}" data-name="${sanitize(product.namaProduk || 'ini')}" aria-label="Hapus produk">
                            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>

                <!-- (MODIFIKASI) Detail Produk Dinamis -->
                <div class="text-sm text-notion-text-subtle dark:text-notion-text-subtle-dark space-y-2">
                    ${productDetailsHTML}
                </div>

                ${tombolHTML}
                
                ${(product.akun || product.password) ? `
                <div class="border-t border-notion-border dark:border-notion-border-dark pt-3 mt-3 space-y-2">
                    <h4 class="font-medium">Info Akun:</h4>
                    <p class="text-sm"><strong>Akun:</strong> ${sanitize(product.akun) || 'N/A'}</p>
                    <div class="flex items-center gap-2 password-group-display">
                        <strong class="text-sm">Password:</strong>
                        <input type="password" value="${sanitize(product.password) || ''}" class="password-field-display notion-input text-sm p-1 flex-1" readonly>
                        <button class="btn-icon btn-toggle-password" aria-label="Tampilkan password">
                            <svg class="w-5 h-5 toggle-pass-icon-show" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            <svg class="w-5 h-5 toggle-pass-icon-hide hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064 7 9.542 7 .847 0 1.67.129 2.468.375M17.608 14.608A4.986 4.986 0 0017 12a5 5 0 00-5-5 4.986 4.986 0 00-2.608.608M5 5l14 14"></path></svg>
                        </button>
                    </div>
                </div>
                ` : ''}

                ${product.catatan ? `
                <div class="border-t border-notion-border dark:border-notion-border-dark pt-3 mt-3">
                     <h4 class="font-medium mb-1">Catatan:</h4>
                     <p class="text-sm whitespace-pre-wrap">${sanitize(product.catatan)}</p>
                </div>
                ` : ''}
            </div>
            `;
            
            return card;
        }

        
        // (PERBAIKAN) Diperbarui untuk menggunakan fungsi kartu yang baru
        function renderFilteredProducts() {
            // (Tidak ada perubahan)
            
            // (PERBAIKAN) Pastikan hanya render jika view-nya adalah produk
            if (currentView !== 'my-purchase' && currentView !== 'my-subscribe') {
                productList.innerHTML = ''; // Kosongkan jika bukan tampilan produk
                return;
            }
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            productList.innerHTML = ''; 
            emptyState.classList.add('hidden'); // Sembunyikan status kosong secara default

            // (BARU) Langkah 1: Filter berdasarkan Tampilan (View)
            const viewFilteredProducts = allProducts.filter(product => {
                if (currentView === 'my-purchase') {
                    // Tampilkan 'purchase' ATAU item lama yang tidak punya tipe (backward compatibility)
                    return product.tipeTransaksi === 'purchase' || !product.tipeTransaksi;
                } else if (currentView === 'my-subscribe') {
                    return product.tipeTransaksi === 'subscribe';
                }
                return false; // Seharusnya tidak terjadi
            });

            // (DIUBAH) Langkah 2: Filter berdasarkan Pencarian (Search)
            const filteredProducts = viewFilteredProducts.filter(product => {
                if (searchTerm === "") {
                    return true; 
                }
                return (
                    product.namaProduk?.toLowerCase().includes(searchTerm) ||
                    product.ownerProduk?.toLowerCase().includes(searchTerm) ||
                    product.email?.toLowerCase().includes(searchTerm) ||
                    product.tipeProduk?.toLowerCase().includes(searchTerm) ||
                    product.akun?.toLowerCase().includes(searchTerm) ||
                    product.catatan?.toLowerCase().includes(searchTerm)
                );
            });
            
            // (PERBAIKAN) Sesuaikan layout list berdasarkan view
            if (isCardViewCollapsed) {
                productList.className = "space-y-2"; // Jarak lebih rapat
            } else {
                productList.className = "space-y-4"; // Jarak normal
            }

            // (DIUBAH) Langkah 3: Logika Tampilan Kosong (Empty State)
            if (viewFilteredProducts.length === 0) {
                // Jika tidak ada item SAMA SEKALI untuk tampilan ini
                if (currentView === 'my-purchase') {
                    emptyState.innerHTML = '<p>Belum ada produk "Purchase" yang disimpan.</p><p class="text-sm">Klik "Tambah Produk Baru" untuk memulai.</p>';
                } else {
                    emptyState.innerHTML = '<p>Belum ada produk "Subscribe" yang disimpan.</p><p class="text-sm">Klik "Tambah Produk Baru" untuk menambahkannya.</p>';
                }
                emptyState.classList.remove('hidden');
                
            } else if (filteredProducts.length === 0) {
                // Jika ADA item, tapi tidak ada yang cocok dengan pencarian
                emptyState.classList.add('hidden');
                productList.innerHTML = `<p class="text-center text-notion-text-subtle py-10">Tidak ada produk yang cocok dengan pencarian "${searchInput.value}".</p>`;
            } else {
                // Jika ada item dan cocok (atau tidak ada pencarian)
                emptyState.classList.add('hidden');
                filteredProducts.forEach(product => {
                    // (PERBAIKAN) Logika render baru
                    let card;
                    if (isCardViewCollapsed) {
                        card = createCompactCard(product);
                    } else {
                        card = createFullCard(product);
                    }
                    productList.appendChild(card);
                });
            }
        }

        async function handleFormSubmit(e) {
            // (Tidak ada perubahan)
            e.preventDefault();
            hideModalError(); // Sembunyikan error lama
            
            const collectionPath = getCollectionPath('products'); // (PERBAIKAN)
            if (!collectionPath) {
                showModalError("Gagal mendapatkan path database. Coba login ulang.");
                return;
            }
            
            // Validasi 'Lainnya'
            let emailValue = emailSelect.value;
            if (emailValue === 'Lainnya') {
                emailValue = emailLainnyaInput.value.trim();
            }
            
            let tipeProdukValue = tipeProdukSelect.value;
            if (tipeProdukValue === 'Lainnya') {
                tipeProdukValue = tipeProdukLainnyaInput.value.trim();
            }

            // Ubah string link menjadi array
            const linkAksesString = document.getElementById('linkAkses').value;
            const linkAksesArray = linkAksesString
                .split('\n')
                .map(link => link.trim())
                .filter(link => link.length > 0);

            const productId = document.getElementById('product-id').value;
            
            // (MODIFIKASI) Membangun data berdasarkan Tipe Transaksi
            const tipeTransaksiValue = tipeTransaksiSelect.value;
            
            // (MODIFIKASI) Validasi dasar
            if (!tipeTransaksiValue) {
                showModalError("Harap pilih 'Tipe Entri' (Purchase atau Subscribe).");
                return;
            }
            if (!document.getElementById('namaProduk').value) {
                showModalError("Harap isi 'Nama Produk'.");
                return;
            }
            // (AKHIR MODIFIKASI) Validasi dasar

            // Data bersama
            let productData = {
                tipeTransaksi: tipeTransaksiValue,
                namaProduk: document.getElementById('namaProduk').value,
                ownerProduk: document.getElementById('ownerProduk').value,
                email: emailValue,
                linkAkses: linkAksesArray,
                tipeProduk: tipeProdukValue,
                akun: document.getElementById('akun').value,
                password: document.getElementById('password').value,
                catatan: document.getElementById('catatan').value,
            };

            if (tipeTransaksiValue === 'purchase') {
                // Validasi khusus purchase
                if (!tanggalBeliInput.value) {
                    showModalError("Harap isi 'Tanggal Beli' untuk Purchase.");
                    return;
                }
                // Tambahkan data khusus purchase
                productData.tanggalBeli = tanggalBeliInput.value;
                productData.hargaBeli = document.getElementById('hargaBeli').valueAsNumber || 0;
            } else if (tipeTransaksiValue === 'subscribe') {
                 // Validasi khusus subscribe
                if (!tanggalMulaiInput.value) {
                    showModalError("Harap isi 'Tanggal Mulai' untuk Subscribe.");
                    return;
                }
                
                let periodeLanggananValue = periodeLanggananSelect.value;
                if (periodeLanggananValue === 'Lainnya') {
                    periodeLanggananValue = periodeLanggananLainnyaInput.value.trim() || 'Lainnya';
                }
                
                if (!periodeLanggananValue || periodeLanggananValue === 'Lainnya') {
                     showModalError("Harap pilih atau isi 'Periode Langganan' untuk Subscribe.");
                    return;
                }
                
                // Tambahkan data khusus subscribe
                productData.tanggalMulai = tanggalMulaiInput.value;
                productData.hargaLangganan = hargaLanggananInput.valueAsNumber || 0;
                productData.periodeLangganan = periodeLanggananValue;
            }

            try {
                if (productId) {
                    const docRef = doc(db, collectionPath, productId);
                    await setDoc(docRef, productData);
                } else {
                    const colRef = collection(db, collectionPath);
                    await addDoc(colRef, productData);
                } // (PERBAIKAN) Kurung kurawal '}' yang hilang ditambahkan di sini
                closeFormModal();
            } catch (error) {
                console.error("Gagal menyimpan produk:", error);
                showModalError("Gagal menyimpan data ke database. Silakan coba lagi.");
            }
        }
    
        async function deleteProduct() {
            // (Tidak ada perubahan)
            if (!productToDeleteId) return;
            const collectionPath = getCollectionPath('products'); // (PERBAIKAN)
            if (!collectionPath) return;
            
            try {
                const docRef = doc(db, collectionPath, productToDeleteId);
                await deleteDoc(docRef);
                closeConfirmDeleteModal();
            } catch (error) {
                console.error("Gagal menghapus produk:", error);
                alert("Gagal menghapus data.");
            }
        }
        
        // (MODIFIKASI) Menggunakan modal error, bukan alert
        async function loadProductForEdit(id) {
            // (Tidak ada perubahan)
            const collectionPath = getCollectionPath('products'); // (PERBAIKAN)
            if (!collectionPath) return;
            
            try {
                const docRef = doc(db, collectionPath, id);
                const docSnap = await getDoc(docRef); // Menggunakan getDoc
                if (docSnap.exists()) {
                    openFormModal({ id: docSnap.id, ...docSnap.data() });
                } else {
                    console.error("Produk tidak ditemukan untuk diedit");
                    // Tidak bisa membuka modal jika data tidak ada
                }
            } catch (error) {
                console.error("Gagal mengambil data untuk edit:", error);
                openFormModal(); // Buka modal kosong
                showModalError("Gagal memuat data produk. Silakan tutup dan coba lagi.");
            }
        }
        
        
        // --- 4b. CRUD LINK (BARU) ---
        
        function loadLinks() {
            if (!userId) return;
            const collectionPath = getCollectionPath('links');
            if (!collectionPath) return; 

            loadingStateLink.classList.remove('hidden');
            emptyStateLink.classList.add('hidden');
            linkList.innerHTML = '';
            
            if (unsubscribeFromLinks) {
                unsubscribeFromLinks();
            }

            const linksCol = collection(db, collectionPath);
            
            unsubscribeFromLinks = onSnapshot(linksCol, (snapshot) => {
                loadingStateLink.classList.add('hidden');
                
                allLinks = []; // Selalu reset
                snapshot.forEach(doc => {
                    allLinks.push({ id: doc.id, ...doc.data() });
                });

                // Urutkan berdasarkan nama
                allLinks.sort((a, b) => (a.namaTools || '').localeCompare(b.namaTools || ''));
                
                renderFilteredLinks(); // Render ulang setiap ada perubahan data

            }, (error) => {
                console.error("Gagal memuat link:", error);
                loadingStateLink.textContent = "Gagal memuat data link.";
            });
        }
        
        function createLinkCard(link) {
            const card = document.createElement('div');
            card.dataset.id = link.id;
            
            // Fungsi utilitas sanitasi
            const sanitize = (str) => {
                if (!str) return '';
                const temp = document.createElement('div');
                temp.textContent = str;
                return temp.innerHTML;
            };
            
            // Fungsi untuk mendapatkan domain dari URL (Tidak lagi digunakan di tampilan, tapi tetap ada)
            const getDomain = (url) => {
                try {
                    const parsedUrl = new URL(url);
                    return parsedUrl.hostname.replace(/^www\./, '');
                } catch (e) {
                    return ''; 
                }
            };
            
            // const domainName = getDomain(link.linkAkses || ''); // Dihapus dari penggunaan di bawah

            // REVISION: Menggunakan class 'uppercase' untuk judul
            card.className = "glass-card overflow-hidden p-4 space-y-4";
            
            const catatanHTML = link.catatan ? `
                <div class="border-t border-notion-border dark:border-notion-border-dark pt-3">
                     <h4 class="font-medium mb-1">Catatan:</h4>
                     <p class="text-sm whitespace-pre-wrap">${sanitize(link.catatan)}</p>
                </div>
            ` : '';
            
            // (PERBAIKAN BARU) Logika untuk Tag
            let tagsHTML = '';
            if (link.tags && typeof link.tags === 'string' && link.tags.trim() !== '') {
                const tagsArray = link.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                if (tagsArray.length > 0) {
                    tagsHTML = '<div class="flex flex-wrap gap-2 mb-2">'; // Added mb-2 for spacing
                    tagsHTML += tagsArray.map(tag => `
                        <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-indigo-600 bg-indigo-200 dark:bg-indigo-800 dark:text-indigo-300">
                            ${sanitize(tag)}
                        </span>
                    `).join('');
                    tagsHTML += '</div>';
                }
            }
            // (AKHIR PERBAIKAN)

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1 min-w-0">
                        <h3 class="text-lg font-bold truncate uppercase">${sanitize(link.namaTools || 'Tanpa Judul')}</h3>
                        <!-- REVISION: Baris URL Dihapus sepenuhnya -->
                    </div>
                    <div class="flex-shrink-0 ml-4 flex gap-2"> <!-- Added flex gap-2 for better button layout -->
                        <button class="btn-icon btn-edit-link" data-id="${link.id}" aria-label="Edit link">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                        <button class="btn-icon btn-delete-link" data-id="${link.id}" data-name="${sanitize(link.namaTools || 'ini')}" aria-label="Hapus link">
                            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
                
                ${tagsHTML} <!-- Ditampilkan di sini, di bawah judul -->

                <!-- REVISION: Primary button for the link, using a full-width block style -->
                <a href="${sanitize(link.linkAkses)}" target="_blank" rel="noopener noreferrer" class="btn-primary w-full flex items-center justify-center gap-2">
                    Buka ${sanitize(link.namaTools || 'Link')}
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002 2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                </a>
                
                ${catatanHTML}
            `;
            return card;
        }

        function renderFilteredLinks() {
            // (PERBAIKAN) Pastikan hanya render jika view-nya adalah link
            if (currentView !== 'my-link') {
                linkList.innerHTML = '';
                return;
            }

            const searchTerm = searchInput.value.toLowerCase().trim(); // (PERBAIKAN BARU)
            linkList.innerHTML = ''; 
            emptyStateLink.classList.add('hidden'); // (PERBAIKAN BARU)

            // (PERBAIKAN BARU) Filter links
            const filteredLinks = allLinks.filter(link => {
                if (searchTerm === "") {
                    return true;
                }
                return (
                    link.namaTools?.toLowerCase().includes(searchTerm) ||
                    link.linkAkses?.toLowerCase().includes(searchTerm) ||
                    link.tags?.toLowerCase().includes(searchTerm) || // (PERBAIKAN BARU)
                    link.catatan?.toLowerCase().includes(searchTerm)
                );
            });
            
            // REVISION: Mengubah teks empty state agar sesuai dengan "My Tools"
            if (allLinks.length === 0) { // (PERBAIKAN) Cek data asli
                emptyStateLink.innerHTML = '<p>Belum ada tools yang disimpan.</p><p class="text-sm">Klik "Tambah Link Baru" untuk memulai.</p>';
                emptyStateLink.classList.remove('hidden');
            } else if (filteredLinks.length === 0) { // (PERBAIKAN) Cek data filter
                linkList.innerHTML = `<p class="text-center text-notion-text-subtle py-10">Tidak ada tools yang cocok dengan pencarian "${searchInput.value}".</p>`;
            } else {
                emptyStateLink.classList.add('hidden');
                filteredLinks.forEach(link => { // (PERBAIKAN) Gunakan filteredLinks
                    const card = createLinkCard(link);
                    linkList.appendChild(card);
                });
            }
        }

        async function handleLinkFormSubmit(e) {
            e.preventDefault();
            const linkModalError = document.getElementById('link-modal-error');
            linkModalError.classList.add('hidden');
            
            const collectionPath = getCollectionPath('links');
            if (!collectionPath) {
                linkModalError.textContent = "Gagal mendapatkan path database. Coba login ulang.";
                linkModalError.classList.remove('hidden');
                return;
            }
            
            const namaTools = document.getElementById('link-nama').value;
            const linkAkses = document.getElementById('link-akses').value;
            
            if (!namaTools || !linkAkses) {
                linkModalError.textContent = "Harap isi 'Nama Tools' dan 'Link Akses'.";
                linkModalError.classList.remove('hidden');
                return;
            }
            
            // Validasi URL sederhana
            try {
                new URL(linkAkses);
            } catch (_) {
                linkModalError.textContent = "Format 'Link Akses' tidak valid. Pastikan diawali http:// atau https://";
                linkModalError.classList.remove('hidden');
                return;
            }

            const linkId = document.getElementById('link-id').value;
            
            const linkData = {
                namaTools: namaTools,
                linkAkses: linkAkses,
                tags: document.getElementById('link-tag').value.trim(), // (PERBAIKAN BARU)
                catatan: document.getElementById('link-catatan').value,
            };

            try {
                if (linkId) {
                    const docRef = doc(db, collectionPath, linkId);
                    await setDoc(docRef, linkData);
                } else {
                    const colRef = collection(db, collectionPath);
                    await addDoc(colRef, linkData);
                }
                closeLinkFormModal();
            } catch (error) {
                console.error("Gagal menyimpan link:", error);
                linkModalError.textContent = "Gagal menyimpan data ke database. Silakan coba lagi.";
                linkModalError.classList.remove('hidden');
            }
        }

        async function deleteLink() {
            if (!linkToDeleteId) return;
            const collectionPath = getCollectionPath('links');
            if (!collectionPath) return;
            
            try {
                const docRef = doc(db, collectionPath, linkToDeleteId);
                await deleteDoc(docRef);
                closeConfirmDeleteLinkModal();
            } catch (error) {
                console.error("Gagal menghapus link:", error);
                alert("Gagal menghapus data link.");
            }
        }

        async function loadLinkForEdit(id) {
            const collectionPath = getCollectionPath('links');
            if (!collectionPath) return;
            
            try {
                const docRef = doc(db, collectionPath, id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    openLinkFormModal({ id: docSnap.id, ...docSnap.data() });
                } else {
                    console.error("Link tidak ditemukan untuk diedit");
                }
            } catch (error) {
                console.error("Gagal mengambil data link untuk edit:", error);
                openLinkFormModal(); 
                document.getElementById('link-modal-error').textContent = "Gagal memuat data link. Silakan tutup dan coba lagi.";
                document.getElementById('link-modal-error').classList.remove('hidden');
            }
        }


        // (PERBAIKAN BARU)
        // --- 4c. CRUD PASSWORD ---
        
        function loadPasswords() {
            if (!userId) return;
            const collectionPath = getCollectionPath('passwords');
            if (!collectionPath) return; 

            loadingStatePassword.classList.remove('hidden');
            emptyStatePassword.classList.add('hidden');
            passwordList.innerHTML = '';
            
            if (unsubscribeFromPasswords) {
                unsubscribeFromPasswords();
            }

            const passwordsCol = collection(db, collectionPath);
            
            unsubscribeFromPasswords = onSnapshot(passwordsCol, (snapshot) => {
                loadingStatePassword.classList.add('hidden');
                
                allPasswords = []; // Selalu reset
                snapshot.forEach(doc => {
                    allPasswords.push({ id: doc.id, ...doc.data() });
                });

                // Urutkan berdasarkan nama
                allPasswords.sort((a, b) => (a.namaSitus || '').localeCompare(b.namaSitus || ''));
                
                renderFilteredPasswords(); // Render ulang setiap ada perubahan data

            }, (error) => {
                console.error("Gagal memuat password:", error);
                loadingStatePassword.textContent = "Gagal memuat data password.";
            });
        }
        
        function createPasswordCard(password) {
            const card = document.createElement('div');
            card.dataset.id = password.id;
            
            // Fungsi utilitas sanitasi
            const sanitize = (str) => {
                if (!str) return '';
                const temp = document.createElement('div');
                temp.textContent = str;
                return temp.innerHTML;
            };

            // REVISION: Menggunakan class 'uppercase' untuk judul
            card.className = "glass-card overflow-hidden p-4";
            
            const catatanHTML = password.catatan ? `
                <div class="border-t border-notion-border dark:border-notion-border-dark pt-3 mt-3">
                     <h4 class="font-medium mb-1">Catatan:</h4>
                     <p class="text-sm whitespace-pre-wrap">${sanitize(password.catatan)}</p>
                </div>
            ` : '';

            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1 min-w-0">
                        <h3 class="text-lg font-bold truncate uppercase">${sanitize(password.namaSitus || 'Tanpa Judul')}</h3>
                        <p class="text-sm text-notion-text-subtle dark:text-notion-text-subtle-dark truncate">${sanitize(password.username)}</p>
                    </div>
                    <div class="flex-shrink-0 ml-4">
                        <button class="btn-icon btn-edit-password" data-id="${password.id}" aria-label="Edit password">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                        <button class="btn-icon btn-delete-password" data-id="${password.id}" data-name="${sanitize(password.namaSitus || 'ini')}" aria-label="Hapus password">
                            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 password-group-display">
                    <strong class="text-sm">Password:</strong>
                    <input type="password" value="${sanitize(password.password || '')}" class="password-field-display notion-input text-sm p-1 flex-1" readonly>
                    <button class="btn-icon btn-toggle-password" aria-label="Tampilkan password">
                        <svg class="w-5 h-5 toggle-pass-icon-show" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        <svg class="w-5 h-5 toggle-pass-icon-hide hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064 7 9.542 7 .847 0 1.67.129 2.468.375M17.608 14.608A4.986 4.986 0 0017 12a5 5 0 00-5-5 4.986 4.986 0 00-2.608.608M5 5l14 14"></path></svg>
                    </button>
                </div>
                
                ${catatanHTML}
            `;
            return card;
        }

        function renderFilteredPasswords() {
            if (currentView !== 'my-password') {
                passwordList.innerHTML = '';
                return;
            }

            const searchTerm = searchInput.value.toLowerCase().trim();
            passwordList.innerHTML = ''; 
            emptyStatePassword.classList.add('hidden');

            const filteredPasswords = allPasswords.filter(pass => {
                if (searchTerm === "") {
                    return true;
                }
                return (
                    pass.namaSitus?.toLowerCase().includes(searchTerm) ||
                    pass.username?.toLowerCase().includes(searchTerm) ||
                    pass.catatan?.toLowerCase().includes(searchTerm)
                );
            });
            
            if (allPasswords.length === 0) {
                emptyStatePassword.classList.remove('hidden');
            } else if (filteredPasswords.length === 0) {
                passwordList.innerHTML = `<p class="text-center text-notion-text-subtle py-10">Tidak ada password yang cocok dengan pencarian "${searchInput.value}".</p>`;
            } else {
                emptyStatePassword.classList.add('hidden');
                filteredPasswords.forEach(pass => {
                    const card = createPasswordCard(pass);
                    passwordList.appendChild(card);
                });
            }
        }

        async function handlePasswordFormSubmit(e) {
            e.preventDefault();
            passwordModalError.classList.add('hidden');
            
            const collectionPath = getCollectionPath('passwords');
            if (!collectionPath) {
                passwordModalError.textContent = "Gagal mendapatkan path database. Coba login ulang.";
                passwordModalError.classList.remove('hidden');
                return;
            }
            
            const namaSitus = document.getElementById('password-nama').value;
            const username = document.getElementById('password-username').value;
            const password = document.getElementById('password-password').value;
            
            if (!namaSitus || !username || !password) {
                passwordModalError.textContent = "Harap isi 'Nama Situs', 'Email/Username', dan 'Password'.";
                passwordModalError.classList.remove('hidden');
                return;
            }

            const passwordId = document.getElementById('password-id').value;
            
            const passwordData = {
                namaSitus: namaSitus,
                username: username,
                password: password,
                catatan: document.getElementById('password-catatan').value,
            };

            try {
                if (passwordId) {
                    const docRef = doc(db, collectionPath, passwordId);
                    await setDoc(docRef, passwordData);
                } else {
                    const colRef = collection(db, collectionPath);
                    await addDoc(colRef, passwordData);
                }
                closePasswordFormModal();
            } catch (error) {
                console.error("Gagal menyimpan password:", error);
                passwordModalError.textContent = "Gagal menyimpan data ke database. Silakan coba lagi.";
                passwordModalError.classList.remove('hidden');
            }
        }

        async function deletePassword() {
            if (!passwordToDeleteId) return;
            const collectionPath = getCollectionPath('passwords');
            if (!collectionPath) return;
            
            try {
                const docRef = doc(db, collectionPath, passwordToDeleteId);
                await deleteDoc(docRef);
                closeConfirmDeletePasswordModal();
            } catch (error) {
                console.error("Gagal menghapus password:", error);
                alert("Gagal menghapus data password.");
            }
        }

        async function loadPasswordForEdit(id) {
            const collectionPath = getCollectionPath('passwords');
            if (!collectionPath) return;
            
            try {
                const docRef = doc(db, collectionPath, id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    openPasswordFormModal({ id: docSnap.id, ...docSnap.data() });
                } else {
                    console.error("Password tidak ditemukan untuk diedit");
                }
            } catch (error) {
                console.error("Gagal mengambil data password untuk edit:", error);
                openPasswordFormModal(); 
                passwordModalError.textContent = "Gagal memuat data password. Silakan tutup dan coba lagi.";
                passwordModalError.classList.remove('hidden');
            }
        }


        // --- 5. Logika Modal & UI Toggle ---

        // (PERBAIKAN - BARU) Fungsi Sidebar
        function openSidebar() {
            // (Tidak ada perubahan)
            sidebarOverlay.classList.remove('hidden');
            sidebar.classList.remove('-translate-x-full');
            
            // Tunda opacity untuk transisi
            requestAnimationFrame(() => {
                sidebarOverlay.classList.remove('opacity-0');
            });
        }

        // (PERBAIKAN - BARU) Fungsi Sidebar
        function closeSidebar() {
            // (Tidak ada perubahan)
            sidebarOverlay.classList.add('opacity-0');
            sidebar.classList.add('-translate-x-full');

            // Sembunyikan setelah transisi selesai (300ms cocok dengan CSS)
            setTimeout(() => {
                sidebarOverlay.classList.add('hidden');
            }, 300);
        }
        
        // (BARU) Fungsi untuk menampilkan error di dalam modal
        function showModalError(message) {
            // (Tidak ada perubahan)
            const modalError = document.getElementById('modal-error');
            modalError.textContent = message;
            modalError.classList.remove('hidden');
        }
        
        // (BARU) Fungsi untuk menyembunyikan error di dalam modal
        function hideModalError() {
            // (Tidak ada perubahan)
            const modalError = document.getElementById('modal-error');
            modalError.textContent = '';
            modalError.classList.add('hidden');
        }


        // (BARU) Fungsi untuk menampilkan/menyembunyikan field form
        function toggleFormFields() {
            // (Tidak ada perubahan)
            const selectedType = tipeTransaksiSelect.value;
            
            // Sembunyikan semua dulu
            purchaseFields.classList.add('hidden');
            subscribeFields.classList.add('hidden');
            
            if (selectedType === 'purchase') {
                purchaseFields.classList.remove('hidden');
            } else if (selectedType === 'subscribe') {
                subscribeFields.classList.remove('hidden');
            }
        }


        // (MODIFIKASI) Logika reset form dipindahkan
        function openFormModal(product = null) {
            // (Tidak ada perubahan)
            hideModalError();
            
            if (product) {
                // Mode Edit
                modalTitle.textContent = "Edit Produk";
                document.getElementById('product-id').value = product.id;
                
                // (MODIFIKASI) Isi Tipe Transaksi & panggil toggle
                tipeTransaksiSelect.value = product.tipeTransaksi || 'purchase'; // Default ke purchase jika data lama
                toggleFormFields(); // Tampilkan field yang benar
                
                // Isi data purchase
                document.getElementById('tanggalBeli').value = product.tanggalBeli;
                document.getElementById('hargaBeli').value = product.hargaBeli;
                
                // (BARU) Isi data subscribe
                document.getElementById('tanggalMulai').value = product.tanggalMulai;
                document.getElementById('hargaLangganan').value = product.hargaLangganan;

                // (BARU) Logika 'Lainnya' untuk Periode Langganan
                const predefinedPeriode = Array.from(periodeLanggananSelect.options).map(opt => opt.value);
                if (product.periodeLangganan && predefinedPeriode.includes(product.periodeLangganan)) {
                    periodeLanggananSelect.value = product.periodeLangganan;
                    periodeLanggananLainnyaInput.value = '';
                    periodeLanggananLainnyaContainer.classList.add('hidden');
                } else if (product.periodeLangganan) {
                    periodeLanggananSelect.value = 'Lainnya';
                    periodeLanggananLainnyaInput.value = product.periodeLangganan;
                    periodeLanggananLainnyaContainer.classList.remove('hidden');
                } else {
                    periodeLanggananSelect.value = '';
                    periodeLanggananLainnyaInput.value = '';
                    periodeLanggananLainnyaContainer.classList.add('hidden');
                }

                // ... (Isi sisa data seperti namaProduk, email, linkAkses, dll - TETAP SAMA) ...
                document.getElementById('namaProduk').value = product.namaProduk;
                document.getElementById('ownerProduk').value = product.ownerProduk;
                
                const predefinedEmailOptions = Array.from(emailSelect.options).map(opt => opt.value);
                if (product.email && predefinedEmailOptions.includes(product.email)) {
                    emailSelect.value = product.email;
                    emailLainnyaInput.value = '';
                    emailLainnyaContainer.classList.add('hidden');
                } else if (product.email) {
                    emailSelect.value = 'Lainnya';
                    emailLainnyaInput.value = product.email;
                    emailLainnyaContainer.classList.remove('hidden');
                } else {
                    emailSelect.value = '';
                    emailLainnyaInput.value = '';
                    emailLainnyaContainer.classList.add('hidden');
                }
                
                let linksString = '';
                if (Array.isArray(product.linkAkses)) {
                    linksString = product.linkAkses.join('\n');
                } else if (typeof product.linkAkses === 'string') {
                    linksString = product.linkAkses;
                }
                document.getElementById('linkAkses').value = linksString;
                
                const predefinedOptions = Array.from(tipeProdukSelect.options).map(opt => opt.value);
                if (product.tipeProduk && predefinedOptions.includes(product.tipeProduk)) {
                    tipeProdukSelect.value = product.tipeProduk;
                    tipeProdukLainnyaInput.value = '';
                    tipeProdukLainnyaContainer.classList.add('hidden');
                } else if (product.tipeProduk) {
                    tipeProdukSelect.value = 'Lainnya';
                    tipeProdukLainnyaInput.value = product.tipeProduk;
                    tipeProdukLainnyaContainer.classList.remove('hidden');
                } else {
                    tipeProdukSelect.value = '';
                    tipeProdukLainnyaInput.value = '';
                    tipeProdukLainnyaContainer.classList.add('hidden');
                }

                document.getElementById('akun').value = product.akun;
                document.getElementById('password').value = product.password;
                document.getElementById('catatan').value = product.catatan;
                
                // (BARU) Tampilkan fitur Gemini
                geminiFeatureContainer.classList.remove('hidden');
                geminiLoading.classList.add('hidden');
                geminiResponseContainer.classList.add('hidden');
                geminiResponseContainer.innerHTML = '';
                
            } else {
                // Mode Tambah
                productForm.reset(); 
                modalTitle.textContent = "Tambah Produk Baru";
                document.getElementById('product-id').value = '';
                
                // (BARU) Pastikan field dinamis tersembunyi
                toggleFormFields();
                
                // (DIPINDAH) Jalankan 'clear-btn' logic setelah reset
                productForm.querySelectorAll('.input-wrapper input, .input-wrapper textarea').forEach(input => {
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                });
                
                // (BARU) Sembunyikan fitur Gemini
                geminiFeatureContainer.classList.add('hidden');
                geminiLoading.classList.add('hidden');
                geminiResponseContainer.innerHTML = '';
            }

            // ... (trigger 'input' event untuk tombol 'x' - TETAP SAMA) ...
            productForm.querySelectorAll('.input-wrapper input, .input-wrapper textarea').forEach(input => {
                input.dispatchEvent(new Event('input', { bubbles: true }));
            });

            formModal.classList.remove('hidden');
        }
        
        function closeFormModal() {
            // (Tidak ada perubahan)
            formModal.classList.add('hidden');
            productForm.reset(); // Reset di sini aman
            hideModalError();
            
            // (BARU) Sembunyikan field dinamis & container 'Lainnya'
            purchaseFields.classList.add('hidden');
            subscribeFields.classList.add('hidden');
            tipeProdukLainnyaContainer.classList.add('hidden');
            emailLainnyaContainer.classList.add('hidden');
            periodeLanggananLainnyaContainer.classList.add('hidden');
            
            // (BARU) Sembunyikan fitur Gemini
            geminiFeatureContainer.classList.add('hidden');
            geminiLoading.classList.add('hidden');
            geminiResponseContainer.innerHTML = '';
        }
        
        function openConfirmDeleteModal(id, name) {
            // (Tidak ada perubahan)
            productToDeleteId = id;
            productNameToDelete.textContent = name;
            confirmDeleteModal.classList.remove('hidden');
        }

        function closeConfirmDeleteModal() {
            // (Tidak ada perubahan)
            productToDeleteId = null;
            confirmDeleteModal.classList.add('hidden');
        }
        
        // (PERBAIKAN BARU) Modal untuk Link
        function openLinkFormModal(link = null) {
            linkModalError.classList.add('hidden');
            
            if (link) {
                // Mode Edit Link
                linkModalTitle.textContent = "Edit Link";
                document.getElementById('link-id').value = link.id;
                document.getElementById('link-nama').value = link.namaTools;
                // REVISION: Link Akses diperlihatkan di modal edit
                document.getElementById('link-akses').value = link.linkAkses;
                document.getElementById('link-tag').value = link.tags || ''; // (PERBAIKAN BARU)
                document.getElementById('link-catatan').value = link.catatan;
            } else {
                // Mode Tambah Link
                linkForm.reset();
                linkModalTitle.textContent = "Tambah Tools Baru";
                document.getElementById('link-id').value = '';
            }
            
            // Trigger 'input' event untuk tombol 'x'
            linkForm.querySelectorAll('.input-wrapper input, .input-wrapper textarea').forEach(input => {
                input.dispatchEvent(new Event('input', { bubbles: true }));
            });
            
            linkFormModal.classList.remove('hidden');
        }
        
        function closeLinkFormModal() {
            linkFormModal.classList.add('hidden');
            linkForm.reset();
            linkModalError.classList.add('hidden');
        }

        function openConfirmDeleteLinkModal(id, name) {
            linkToDeleteId = id;
            linkNameToDelete.textContent = name;
            confirmDeleteLinkModal.classList.remove('hidden');
        }

        function closeConfirmDeleteLinkModal() {
            linkToDeleteId = null;
            confirmDeleteLinkModal.classList.add('hidden');
        }
        
        // (PERBAIKAN BARU) Modal untuk Password
        function openPasswordFormModal(password = null) {
            passwordModalError.classList.add('hidden');
            
            if (password) {
                // Mode Edit Password
                passwordModalTitle.textContent = "Edit Password";
                document.getElementById('password-id').value = password.id;
                document.getElementById('password-nama').value = password.namaSitus;
                document.getElementById('password-username').value = password.username;
                document.getElementById('password-password').value = password.password;
                document.getElementById('password-catatan').value = password.catatan;
            } else {
                // Mode Tambah Password
                passwordForm.reset();
                passwordModalTitle.textContent = "Tambah Password Baru";
                document.getElementById('password-id').value = '';
            }
            
            // Trigger 'input' event untuk tombol 'x'
            passwordForm.querySelectorAll('.input-wrapper input, .input-wrapper textarea').forEach(input => {
                input.dispatchEvent(new Event('input', { bubbles: true }));
            });
            
            passwordFormModal.classList.remove('hidden');
        }
        
        function closePasswordFormModal() {
            passwordFormModal.classList.add('hidden');
            passwordForm.reset();
            passwordModalError.classList.add('hidden');
        }

        function openConfirmDeletePasswordModal(id, name) {
            passwordToDeleteId = id;
            passwordNameToDelete.textContent = name;
            confirmDeletePasswordModal.classList.remove('hidden');
        }

        function closeConfirmDeletePasswordModal() {
            passwordToDeleteId = null;
            confirmDeletePasswordModal.classList.add('hidden');
        }


        
        // REVISION: Fungsi diperbaiki untuk mencari input di dalam grup
        function togglePasswordVisibility(button) {
            // Cari elemen parent terdekat yang membungkus input dan tombol (contoh: .input-wrapper di modal, .password-group-display di card)
            const parentGroup = button.closest('.input-wrapper') || button.closest('.password-group-display');
            if (!parentGroup) {
                console.error("Gagal menemukan grup password.");
                return;
            }
            
            // Cari input password di dalam grup tersebut
            const input = parentGroup.querySelector('input[type="password"], input[type="text"]');
            if (!input) {
                console.error("Gagal menemukan input password.");
                return;
            }
            
            // Cari ikon di dalam tombol
            const iconShow = button.querySelector('.toggle-pass-icon-show');
            const iconHide = button.querySelector('.toggle-pass-icon-hide');

            if (input.type === 'password') {
                input.type = 'text';
                iconShow.classList.add('hidden');
                iconHide.classList.remove('hidden');
            } else {
                input.type = 'password';
                iconShow.classList.remove('hidden');
                iconHide.classList.add('hidden');
            }
        }
        
        // (PERBAIKAN) Fungsi untuk Card View Toggle
        function toggleCardView() {
            isCardViewCollapsed = !isCardViewCollapsed; // Toggle status
            updateCardToggleUI(); // Perbarui tampilan tombol
            renderFilteredProducts(); // Render ulang daftar produk
        }
        
        // (PERBAIKAN) Fungsi untuk update UI tombol toggle
        function updateCardToggleUI() {
            if (isCardViewCollapsed) {
                cardToggleSwitch.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                cardToggleSwitch.classList.add('bg-blue-600', 'dark:bg-blue-500');
                cardToggleHandle.classList.remove('translate-x-0');
                cardToggleHandle.classList.add('translate-x-5');
                cardToggleSwitch.setAttribute('aria-checked', 'true');
            } else {
                cardToggleSwitch.classList.remove('bg-blue-600', 'dark:bg-blue-500');
                cardToggleSwitch.classList.add('bg-gray-200', 'dark:bg-gray-700');
                cardToggleHandle.classList.remove('translate-x-5');
                cardToggleHandle.classList.add('translate-x-0');
                cardToggleSwitch.setAttribute('aria-checked', 'false');
            }
        }

        // --- 6. Logika Gemini API (BARU) ---

        /**
         * (BARU) Fungsi inti untuk memanggil Gemini API dengan exponential backoff.
         */
        async function callGeminiAPI(userQuery, systemInstruction, maxRetries = 3) {
            // (Tidak ada perubahan)
            const apiKey = ""; // Biarkan kosong, akan di-handle oleh environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                },
            };

            let delay = 1000; // 1 detik
            for (let i = 0; i <= maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Jika status bukan OK, coba lagi
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text; // Sukses
                    } else {
                        // Jika respon OK tapi data tidak ada
                        throw new Error("Respon API tidak valid atau kosong.");
                    }
                } catch (error) {
                    console.warn(`Upaya API ${i + 1} gagal:`, error.message);
                    if (i === maxRetries) {
                        // Jika sudah mencapai batas percobaan
                        throw new Error("Gagal menghubungi API setelah beberapa kali percobaan.");
                    }
                    // Tunggu sebelum mencoba lagi
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Double delay untuk backoff
                }
            }
        }

        /**
         * (BARU) Menangani klik tombol Gemini untuk mendapatkan info
         */
        async function handleGeminiRequest() {
            // (Tidak ada perubahan)
            geminiLoading.classList.remove('hidden');
            geminiResponseContainer.classList.add('hidden');
            geminiResponseContainer.innerHTML = '';

            // Ambil data dari form
            const namaProduk = document.getElementById('namaProduk').value;
            const tipeProduk = document.getElementById('tipeProduk').value;
            const tipeProdukLainnya = document.getElementById('tipeProdukLainnya').value;

            let tipe = tipeProduk;
            if (tipe === 'Lainnya') {
                tipe = tipeProdukLainnya.trim() || 'Produk Digital'; // Default jika 'Lainnya' tapi kosong
            }
            if (tipe === '') {
                tipe = 'Produk Digital'; // Default jika tidak dipilih
            }


            if (!namaProduk) {
                geminiLoading.classList.add('hidden');
                geminiResponseContainer.innerHTML = '<p class="text-red-600 dark:text-red-400">Harap isi Nama Produk terlebih dahulu.</p>';
                geminiResponseContainer.classList.remove('hidden');
                return;
            }

            // Siapkan prompt untuk Gemini
            const systemPrompt = "Anda adalah asisten yang sangat membantu, kreatif, dan ahli dalam produktivitas digital. Jawab selalu dalam Bahasa Indonesia dengan format yang rapi.";
            const userQuery = `Saya memiliki produk digital bernama "${namaProduk}". Tipe produk ini adalah "${tipe}". 
    
Tolong berikan saya 2 hal:
1.  Tiga (3) tips singkat dan praktis tentang cara terbaik untuk belajar atau mendapatkan nilai maksimal dari produk ini.
2.  Satu (1) ide atau fitur tambahan yang mungkin relevan atau bisa diintegrasikan dengan produk ini untuk meningkatkan nilainya.

Format jawaban Anda dengan jelas menggunakan poin-poin.`;

            try {
                // Panggil API
                const responseText = await callGeminiAPI(userQuery, systemPrompt);
                
                // Format sederhana: ganti baris baru dengan <br> dan sanitasi
                const formattedResponse = responseText
                    .replace(/</g, "&lt;") // Sanitasi dasar
                    .replace(/>/g, "&gt;")
                    .replace(/\n/g, '<br>');

                geminiLoading.classList.add('hidden');
                geminiResponseContainer.innerHTML = formattedResponse;
                geminiResponseContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Gemini API Error:", error);
                geminiLoading.classList.add('hidden');
                geminiResponseContainer.innerHTML = `<p class="text-red-600 dark:text-red-400">Maaf, terjadi kesalahan saat menghubungi AI. Silakan coba lagi nanti.</p>`;
                geminiResponseContainer.classList.remove('hidden');
            }
        }


        // --- 7. Event Listeners --- (Sebelumnya 6)
        
        // --- Listener Auth ---
        // (Tidak ada perubahan)
        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegister);
        logoutBtn.addEventListener('click', handleLogout);
        anonymousLoginBtn.addEventListener('click', handleAnonymousLogin);
        googleLoginBtn.addEventListener('click', handleGoogleLogin); // (PERBAIKAN) Ditambahkan
        
        showRegisterBtn.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            authError.textContent = '';
        });
        showLoginBtn.addEventListener('click', () => {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            authError.textContent = '';
        });

        // --- Listener Search ---
        // (PERBAIKAN) Diperbarui untuk menangani view yang berbeda
        searchInput.addEventListener('input', () => {
            if (currentView === 'my-purchase' || currentView === 'my-subscribe') {
                renderFilteredProducts();
            } else if (currentView === 'my-link') {
                renderFilteredLinks(); // (PERBAIKAN BARU)
            } else if (currentView === 'my-password') {
                renderFilteredPasswords(); // (PERBAIKAN BARU)
            }
        });
        
        searchToggleBtn.addEventListener('click', () => {
            searchWrapper.classList.remove('hidden');
            searchToggleBtn.classList.add('hidden');
            searchInput.focus();
        });
        searchInput.addEventListener('blur', () => {
            if (searchInput.value.trim() === '') {
                searchWrapper.classList.add('hidden');
                searchToggleBtn.classList.remove('hidden');
            }
        });

        // --- Listener Sidebar ---
        // (PERBAIKAN - BARU) Listener untuk Buka/Tutup Sidebar
        sidebarToggleBtn.addEventListener('click', openSidebar);
        sidebarCloseBtn.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);

        // (PERBAIKAN) Logika klik item menu sidebar disederhanakan
        sidebarMenuList.addEventListener('click', (e) => { 
            const menuItem = e.target.closest('.menu-item');
            if (!menuItem) return;
            e.preventDefault();
            
            const action = menuItem.dataset.action;

            updateMainView(action);
            closeSidebar(); 
        });
        
        // (PERBAIKAN) Listener untuk toggle kartu
        cardToggleSwitch.addEventListener('click', toggleCardView);

        // --- Listener Tombol & Modal ---

        // Tombol utama
        addProductBtn.addEventListener('click', () => openFormModal());
        addLinkBtn.addEventListener('click', () => openLinkFormModal()); // (PERBAIKAN BARU)
        addPasswordBtn.addEventListener('click', () => openPasswordFormModal()); // (PERBAIKAN BARU)
        
        // Tombol modal form PRODUK
        modalCloseBtn.addEventListener('click', closeFormModal);
        modalCancelBtn.addEventListener('click', closeFormModal);
        productForm.addEventListener('submit', handleFormSubmit);
        
        // Tombol modal form LINK (PERBAIKAN BARU)
        linkModalCloseBtn.addEventListener('click', closeLinkFormModal);
        linkModalCancelBtn.addEventListener('click', closeLinkFormModal);
        linkForm.addEventListener('submit', handleLinkFormSubmit);
        
        // (PERBAIKAN BARU) Tombol modal form PASSWORD
        passwordModalCloseBtn.addEventListener('click', closePasswordFormModal);
        passwordModalCancelBtn.addEventListener('click', closePasswordFormModal);
        passwordForm.addEventListener('submit', handlePasswordFormSubmit);
        
        
        // (BARU) Listener untuk menampilkan/menyembunyikan tombol 'x' clear (di SEMUA form modal)
        document.addEventListener('input', (e) => {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                return;
            }
            const wrapper = e.target.closest('.input-wrapper');
            if (!wrapper) return;
            const clearBtn = wrapper.querySelector('.clear-btn');
            if (!clearBtn) return;
            
            if (e.target.value.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
        });
        
        // Tombol modal konfirmasi hapus PRODUK
        cancelDeleteBtn.addEventListener('click', closeConfirmDeleteModal);
        confirmDeleteBtn.addEventListener('click', deleteProduct);
        
        // Tombol modal konfirmasi hapus LINK (PERBAIKAN BARU)
        cancelDeleteLinkBtn.addEventListener('click', closeConfirmDeleteLinkModal);
        confirmDeleteLinkBtn.addEventListener('click', deleteLink);
        
        // (PERBAIKAN BARU) Tombol modal konfirmasi hapus PASSWORD
        cancelDeletePasswordBtn.addEventListener('click', closeConfirmDeletePasswordModal);
        confirmDeletePasswordBtn.addEventListener('click', deletePassword);
        
        // (BARU) Listener untuk dropdown Tipe Transaksi
        tipeTransaksiSelect.addEventListener('change', toggleFormFields);
        
        // (BARU) Listener untuk dropdown Periode Langganan
        periodeLanggananSelect.addEventListener('change', () => {
            // (Tidak ada perubahan)
            if (periodeLanggananSelect.value === 'Lainnya') {
                periodeLanggananLainnyaContainer.classList.remove('hidden');
                periodeLanggananLainnyaInput.focus();
            } else {
                periodeLanggananLainnyaContainer.classList.add('hidden');
                periodeLanggananLainnyaInput.value = '';
            }
        });

        // Listener dropdown (Email & Tipe Produk)
        tipeProdukSelect.addEventListener('change', () => {
            // (Tidak ada perubahan)
            if (tipeProdukSelect.value === 'Lainnya') {
                tipeProdukLainnyaContainer.classList.remove('hidden');
                tipeProdukLainnyaInput.focus();
            } else {
                tipeProdukLainnyaContainer.classList.add('hidden');
                tipeProdukLainnyaInput.value = '';
            }
        });
        emailSelect.addEventListener('change', () => {
            // (Tidak ada perubahan)
            if (emailSelect.value === 'Lainnya') {
                emailLainnyaContainer.classList.remove('hidden');
                emailLainnyaInput.focus();
            } else {
                emailLainnyaContainer.classList.add('hidden');
                emailLainnyaInput.value = '';
            }
        });

        // (PERBAIKAN BESAR) Event delegation untuk kartu produk (DIREVISI)
        productList.addEventListener('click', (e) => {
            // (Tidak ada perubahan)
            const editBtn = e.target.closest('.btn-edit');
            const deleteBtn = e.target.closest('.btn-delete');
            const togglePassBtn = e.target.closest('.btn-toggle-password');
            const compactCard = e.target.closest('.compact-card-clickable');
            const fullCard = e.target.closest('.manually-opened');

            // Prioritas #1: Tombol Edit (selalu memuat modal)
            if (editBtn) {
                const id = editBtn.dataset.id;
                loadProductForEdit(id);
                return;
            }
            
            // Prioritas #2: Tombol Hapus (selalu memuat modal)
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                const name = deleteBtn.dataset.name;
                openConfirmDeleteModal(id, name);
                return;
            }
            
            // Prioritas #3: Tombol Password (hanya toggle)
            // REVISION: Memastikan tombol toggle di card ditangani di sini
            if (togglePassBtn) {
                e.preventDefault(); // Mencegah aksi kartu jika di mode compact
                togglePasswordVisibility(togglePassBtn);
                return;
            }
            
            // Prioritas #4: Link (jangan lakukan apa-apa, biarkan browser)
            if (e.target.tagName === 'A' || e.target.closest('A')) {
                return;
            }

            // Prioritas #5: Klik kartu ringkas (untuk MEMBUKA)
            if (compactCard) {
                const id = compactCard.dataset.id;
                const product = allProducts.find(p => p.id === id);
                if (!product) return;
                
                const newFullCard = createFullCard(product);
                newFullCard.classList.add('manually-opened'); // Tambahkan marker
                compactCard.replaceWith(newFullCard);
                return;
            }
            
            // Prioritas #6: Klik kartu penuh yang dibuka manual (untuk MENUTUP)
            if (fullCard) {
                const id = fullCard.dataset.id;
                const product = allProducts.find(p => p.id === id);
                if (!product) return;
                
                const newCompactCard = createCompactCard(product);
                fullCard.replaceWith(newCompactCard);
                return;
            }
        });
        
        // (PERBAIKAN BARU) Event delegation untuk kartu link
        linkList.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.btn-edit-link');
            const deleteBtn = e.target.closest('.btn-delete-link');
            
            if (editBtn) {
                const id = editBtn.dataset.id;
                loadLinkForEdit(id);
                return;
            }
            
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                const name = deleteBtn.dataset.name;
                openConfirmDeleteLinkModal(id, name);
                return;
            }
            // Tambahan: Link di card sekarang adalah tombol, klik sudah ditangani oleh tag <a> di dalamnya
        });
        
        // (PERBAIKAN BARU) Event delegation untuk kartu password
        passwordList.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.btn-edit-password');
            const deleteBtn = e.target.closest('.btn-delete-password');
            const togglePassBtn = e.target.closest('.btn-toggle-password');
            
            if (editBtn) {
                const id = editBtn.dataset.id;
                loadPasswordForEdit(id);
                return;
            }
            
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                const name = deleteBtn.dataset.name;
                openConfirmDeletePasswordModal(id, name);
                return;
            }
            
            // REVISION: Memastikan tombol toggle di card ditangani di sini
            if (togglePassBtn) {
                e.preventDefault();
                togglePasswordVisibility(togglePassBtn);
                return;
            }
        });
        
        // (MODIFIKASI) Event delegation untuk tombol di dalam form (toggle password, clear, DAN GEMINI)
        // (PERBAIKAN) Diarahkan ke document agar bisa menangani modal-link juga
        document.addEventListener('click', (e) => {
            // (Tidak ada perubahan)
            const togglePassBtn = e.target.closest('.btn-toggle-password');
            const clearBtn = e.target.closest('.clear-btn');
            const geminiBtn = e.target.closest('#gemini-info-btn'); // (BARU)

            // REVISION: Menangani toggle password di modal
            if (togglePassBtn && (e.target.closest('#form-modal') || e.target.closest('#password-form-modal'))) {
                e.preventDefault(); 
                togglePasswordVisibility(togglePassBtn);
                return; 
            }
            
            if (clearBtn) {
                e.preventDefault(); 
                const wrapper = clearBtn.closest('.input-wrapper');
                const input = wrapper.querySelector('input, textarea');
                if (input) {
                    input.value = '';
                    input.dispatchEvent(new Event('input', { bubbles: true })); 
                    input.focus();
                }
                return; 
            }
            
            // (BARU) Menangani klik tombol Gemini
            if (geminiBtn) {
                e.preventDefault(); // Pastikan tidak submit form
                handleGeminiRequest();
                return;
            }
        });

        // --- Mulai Aplikasi ---
        document.addEventListener('DOMContentLoaded', initializeAppCore);
    </script>
</body>
</html>