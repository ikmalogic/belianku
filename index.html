<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKMAL PURCHASE | Gemini Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: Space Grotesk (Tech) & Plus Jakarta Sans (Modern UI) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
    tailwind.config = {
        darkMode: 'class', 
        theme: {
            extend: {
                fontFamily: {
                    sans: ['"Plus Jakarta Sans"', 'sans-serif'], 
                    display: ['"Space Grotesk"', 'sans-serif'],
                },
                colors: {
                    gemini: {
                        bg: '#0B101B',       // Deepest Blue/Black
                        card: '#131B2C',     // Slightly Lighter
                        border: '#2D3748',   // Border
                        primary: '#3B82F6',  // Blue
                        secondary: '#8B5CF6', // Purple
                        accent: '#06B6D4',    // Cyan
                        surface: '#1E293B',
                    }
                },
                animation: {
                    'shimmer': 'shimmer 2s linear infinite',
                    'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                },
                keyframes: {
                    shimmer: {
                        '0%': { backgroundPosition: '-1000px 0' },
                        '100%': { backgroundPosition: '1000px 0' }
                    }
                }
            },
        }
    }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .glass-panel {
                @apply bg-gemini-card/70 backdrop-blur-xl border border-white/10 shadow-xl;
            }
            
            .glass-input {
                @apply bg-black/20 border border-white/10 text-white placeholder-gray-500 rounded-xl focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 focus:outline-none transition-all duration-300;
            }

            .gemini-gradient-text {
                @apply bg-clip-text text-transparent bg-gradient-to-r from-blue-400 via-purple-400 to-cyan-400;
            }

            .btn-gemini-primary {
                @apply relative overflow-hidden bg-gradient-to-r from-blue-600 to-purple-600 text-white font-medium rounded-xl shadow-lg hover:shadow-blue-500/30 transition-all duration-300 hover:scale-[1.02] active:scale-95;
            }

            .btn-gemini-secondary {
                @apply bg-white/5 border border-white/10 text-gray-300 hover:bg-white/10 hover:text-white rounded-xl transition-all duration-200;
            }

            .card-hover-effect {
                @apply hover:border-blue-500/30 hover:shadow-lg hover:shadow-blue-500/10 transition-all duration-300;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0B101B; 
        }
        ::-webkit-scrollbar-thumb {
            background: #2D3748; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4A5568; 
        }

        body {
            background-color: #0B101B;
            background-image: 
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
        }
    </style>
</head>

<body class="text-gray-200 font-sans min-h-screen selection:bg-blue-500/30 selection:text-blue-200">

    <!-- === SIDEBAR === -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm opacity-0 hidden z-40 transition-opacity duration-300"></div>
    <nav id="sidebar" class="fixed top-0 left-0 h-full w-72 glass-panel border-r border-white/10 transform -translate-x-full transition-transform duration-300 z-50 rounded-r-2xl">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg shadow-lg shadow-blue-500/20">I</div>
                    <h2 class="text-xl font-display font-bold tracking-tight text-white">Ikmal<span class="text-blue-400">.ai</span></h2>
                </div>
                <button id="sidebar-close-btn" class="p-2 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <ul id="sidebar-menu-list" class="flex-1 space-y-1 overflow-y-auto">
                <li><button class="w-full text-left px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 hover:bg-white/5 hover:text-blue-300 text-gray-400 active-menu-item" data-action="my-purchase">üì¶ My Purchase</button></li>
                <li><button class="w-full text-left px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 hover:bg-white/5 hover:text-purple-300 text-gray-400" data-action="my-subscribe">üíé My Subscribe</button></li>
                <li><button class="w-full text-left px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 hover:bg-white/5 hover:text-green-300 text-gray-400" data-action="my-password">üîê My Password</button></li>
                <li><button class="w-full text-left px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 hover:bg-white/5 hover:text-yellow-300 text-gray-400" data-action="my-link">üõ†Ô∏è My Tools</button></li>
                
                <li id="card-toggle-wrapper" class="mt-6 pt-6 border-t border-white/10 px-4 flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-400">Compact Mode</span>
                    <button id="card-toggle-switch" type="button" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-white/10 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-[#0B101B]">
                        <span id="card-toggle-handle" class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0"></span>
                    </button>
                </li>
            </ul>

            <div id="user-info" class="hidden mt-auto pt-6 border-t border-white/10">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-gray-700 to-gray-600 flex items-center justify-center">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </div>
                    <span id="user-email" class="text-xs font-medium text-gray-300 truncate w-32"></span>
                </div>
                <button id="logout-btn" class="w-full py-2 text-xs font-medium text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-lg transition-colors text-left px-2">Sign Out</button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container mx-auto max-w-4xl p-4 md:p-6 lg:p-8 min-h-screen flex flex-col">

        <!-- Header -->
        <header class="sticky top-0 z-30 py-4 mb-8 -mx-4 px-4 md:mx-0 md:px-0 bg-[#0B101B]/80 backdrop-blur-md border-b border-white/5 flex justify-between items-center transition-all duration-300">
            <div class="flex items-center gap-4">
                <button id="sidebar-toggle-btn" class="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-gray-300 transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h1 id="page-title" class="text-2xl font-display font-bold text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400 tracking-tight hidden sm:block">
                    My Purchase
                </h1>
            </div>

            <div class="flex items-center gap-3">
                 <!-- Search Bar (Animated) -->
                 <div class="relative hidden group" id="search-wrapper"> 
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="w-4 h-4 text-gray-500 group-focus-within:text-blue-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <input type="text" id="search-input" placeholder="Search anything..." class="glass-input pl-10 pr-4 py-2 text-sm w-40 md:w-64 focus:w-72 transition-all">
                </div>

                <button id="search-toggle-btn" class="p-2 rounded-xl hover:bg-white/10 text-gray-400 transition-colors" aria-label="Open Search">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </button>

                <!-- Theme Toggle (Hidden visually as we force Dark Mode for Gemini Vibe, but logic kept) -->
                <button id="theme-toggle" class="hidden p-2 rounded-xl hover:bg-white/10 text-yellow-400 transition-colors">
                    <svg id="theme-icon-light" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
            </div>
        </header>

        <!-- AUTH SECTION -->
        <div id="auth-container" class="max-w-sm mx-auto my-auto glass-panel p-8 rounded-3xl hidden transform transition-all hover:scale-[1.01]">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-display font-bold gemini-gradient-text mb-2">Welcome Back</h1>
                <p class="text-gray-400 text-sm">Access your digital universe</p>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">EMAIL</label>
                    <input type="email" id="login-email" class="w-full glass-input px-4 py-3 text-sm" placeholder="name@example.com" required>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">PASSWORD</label>
                    <input type="password" id="login-password" class="w-full glass-input px-4 py-3 text-sm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="w-full btn-gemini-primary py-3 text-sm shadow-lg shadow-blue-500/25">Sign In</button>
                <div class="text-center mt-4">
                    <button type="button" id="show-register-btn" class="text-xs text-blue-400 hover:text-blue-300 transition-colors">Create new account</button>
                </div>
            </form>

            <!-- Register Form -->
            <form id="register-form" class="hidden space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">EMAIL</label>
                    <input type="email" id="register-email" class="w-full glass-input px-4 py-3 text-sm" required>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">PASSWORD</label>
                    <input type="password" id="register-password" class="w-full glass-input px-4 py-3 text-sm" minlength="6" required>
                </div>
                <button type="submit" class="w-full btn-gemini-primary py-3 text-sm">Create Account</button>
                <div class="text-center mt-4">
                    <button type="button" id="show-login-btn" class="text-xs text-blue-400 hover:text-blue-300 transition-colors">Back to Login</button>
                </div>
            </form>

            <div class="relative my-8">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/10"></div></div>
                <div class="relative flex justify-center"><span class="bg-[#131B2C] px-3 text-xs text-gray-500">OR CONTINUE WITH</span></div>
            </div>

            <button type="button" id="google-login-btn" class="w-full bg-white text-gray-900 hover:bg-gray-100 font-medium py-3 rounded-xl flex items-center justify-center gap-3 transition-colors text-sm">
                <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691L22.99 21.905L17.509 10.22C15.56 7.903 12.019 6.306 8.327 7.151C5.071 7.892 2.348 10.82 2.022 14.366c-.114 1.251.272 2.493.98 3.491l3.304-3.166z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-0.792 2.237-2.231 4.166-4.087 5.574l6.19-5.238C39.999 36.661 44 31.138 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                Google
            </button>
            <button type="button" id="anonymous-login-btn" class="w-full mt-3 py-2 text-xs text-gray-500 hover:text-gray-300 transition-colors">Guest Access</button>

            <div id="auth-error" class="text-red-400 text-xs text-center mt-4 bg-red-500/10 py-2 rounded-lg hidden"></div>
        </div>


        <!-- MAIN CONTENT AREA -->
        <div id="main-content" class="flex-1 hidden animate-fade-in">
            
            <!-- Action Buttons Toolbar -->
            <div class="flex flex-wrap gap-3 mb-8">
                <!-- Add Product -->
                <div id="add-product-btn-wrapper" class="hidden">
                    <button id="add-product-btn" class="btn-gemini-primary px-5 py-2.5 flex items-center gap-2 text-sm shadow-blue-500/20">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        New Product
                    </button>
                </div>
                <!-- Add Tool -->
                <div id="add-link-btn-wrapper" class="hidden">
                    <button id="add-link-btn" class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-medium rounded-xl shadow-lg px-5 py-2.5 flex items-center gap-2 text-sm hover:scale-[1.02] transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.102 1.101"></path></svg>
                        New Tool
                    </button>
                </div>
                <!-- Add Password -->
                <div id="add-password-btn-wrapper" class="hidden">
                    <button id="add-password-btn" class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-medium rounded-xl shadow-lg px-5 py-2.5 flex items-center gap-2 text-sm hover:scale-[1.02] transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        New Password
                    </button>
                </div>
            </div>

            <!-- Content Areas -->
            <div id="product-content" class="hidden space-y-6">
                <div id="loading-state" class="text-center py-20 hidden"><div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div><p class="mt-4 text-gray-500 text-sm">Syncing data...</p></div>
                <div id="empty-state" class="text-center py-20 border border-dashed border-white/10 rounded-3xl bg-white/5 hidden"><p class="text-gray-400">No data found in this dimension.</p></div>
                <div id="product-list" class="grid grid-cols-1 gap-4"></div>
            </div>

            <div id="password-content" class="hidden space-y-6">
                <div id="loading-state-password" class="text-center py-20 hidden"><div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-emerald-500"></div></div>
                <div id="empty-state-password" class="text-center py-20 border border-dashed border-white/10 rounded-3xl bg-white/5 hidden"><p class="text-gray-400">Vault is empty.</p></div>
                <div id="password-list" class="grid grid-cols-1 gap-4"></div>
            </div>

            <div id="link-content" class="hidden space-y-6">
                <div id="loading-state-link" class="text-center py-20 hidden"><div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-yellow-500"></div></div>
                <div id="empty-state-link" class="text-center py-20 border border-dashed border-white/10 rounded-3xl bg-white/5 hidden"><p class="text-gray-400">No tools linked.</p></div>
                <div id="link-list" class="grid grid-cols-1 gap-4"></div>
            </div>

        </div>
    </div>

    <!-- === MODAL (Universal Style) === -->
    <div id="form-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden transition-opacity duration-300">
        <div class="glass-panel w-full max-w-lg max-h-[90vh] overflow-y-auto rounded-3xl shadow-2xl animate-fade-in-up border border-white/10 bg-[#0B101B]">
            <form id="product-form" class="p-6 md:p-8 space-y-5">
                <div class="flex justify-between items-center pb-4 border-b border-white/10">
                    <h2 id="modal-title" class="text-xl font-display font-bold text-white">New Entry</h2>
                    <button type="button" id="modal-close-btn" class="text-gray-500 hover:text-white transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
                
                <div id="modal-error" class="hidden bg-red-500/10 border border-red-500/20 text-red-400 text-sm p-3 rounded-xl"></div>
                <input type="hidden" id="product-id">

                <!-- Type Selector -->
                <div class="grid grid-cols-2 gap-3 p-1 bg-white/5 rounded-xl">
                    <label class="cursor-pointer">
                        <input type="radio" name="modal_type_transaksi" value="purchase" class="peer sr-only" id="radio-purchase">
                        <div class="text-center py-2 rounded-lg text-sm font-medium text-gray-400 peer-checked:bg-blue-600 peer-checked:text-white transition-all">Purchase</div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="modal_type_transaksi" value="subscribe" class="peer sr-only" id="radio-subscribe">
                        <div class="text-center py-2 rounded-lg text-sm font-medium text-gray-400 peer-checked:bg-purple-600 peer-checked:text-white transition-all">Subscribe</div>
                    </label>
                    <!-- Hidden Select to keep logic working -->
                    <select id="tipeTransaksi" class="hidden"><option value="purchase">Purchase</option><option value="subscribe">Subscribe</option></select>
                </div>

                <div class="space-y-4">
                     <!-- Nama Produk -->
                    <div>
                        <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5 ml-1">Product Name</label>
                        <div class="input-wrapper relative">
                            <input type="text" id="namaProduk" class="glass-input w-full px-4 py-3" placeholder="e.g. Netflix Premium" required>
                        </div>
                    </div>

                    <!-- Gemini Feature Block -->
                    <div id="gemini-feature-container" class="hidden">
                        <button type="button" id="gemini-info-btn" class="w-full relative overflow-hidden group rounded-xl p-[1px]">
                            <span class="absolute inset-0 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 opacity-70 group-hover:opacity-100 transition-opacity duration-300"></span>
                            <div class="relative bg-[#0B101B] hover:bg-[#131B2C] rounded-xl px-4 py-3 flex items-center justify-center gap-2 transition-colors">
                                <span class="gemini-gradient-text font-bold text-sm">‚ú® Ask Gemini 2.0 Flash</span>
                            </div>
                        </button>
                        <div id="gemini-loading" class="hidden mt-3 text-center text-xs text-blue-300 animate-pulse">Consulting the AI...</div>
                        <div id="gemini-response-container" class="hidden mt-3 p-4 bg-blue-900/10 border border-blue-500/20 rounded-xl text-sm text-blue-100 leading-relaxed"></div>
                    </div>

                    <!-- Purchase Fields -->
                    <div id="purchase-fields" class="grid grid-cols-2 gap-4 hidden animate-fade-in">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">DATE</label>
                            <input type="date" id="tanggalBeli" class="glass-input w-full px-3 py-2 text-sm [color-scheme:dark]">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">PRICE (IDR)</label>
                            <input type="number" id="hargaBeli" class="glass-input w-full px-3 py-2 text-sm" placeholder="0">
                        </div>
                    </div>

                    <!-- Subscribe Fields -->
                    <div id="subscribe-fields" class="space-y-4 hidden animate-fade-in">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">START DATE</label>
                                <input type="date" id="tanggalMulai" class="glass-input w-full px-3 py-2 text-sm [color-scheme:dark]">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">PRICE (IDR)</label>
                                <input type="number" id="hargaLangganan" class="glass-input w-full px-3 py-2 text-sm" placeholder="0">
                            </div>
                        </div>
                        <div>
                             <label class="block text-xs font-medium text-gray-500 mb-1">CYCLE</label>
                             <select id="periodeLangganan" class="glass-input w-full px-3 py-2 text-sm">
                                <option value="">Select Cycle...</option>
                                <option value="Bulanan">Monthly</option>
                                <option value="Tahunan">Yearly</option>
                                <option value="Lifetime">Lifetime</option>
                                <option value="Lainnya">Custom</option>
                            </select>
                            <div id="periodeLanggananLainnyaContainer" class="hidden mt-2 input-wrapper"><input type="text" id="periodeLanggananLainnya" class="glass-input w-full px-3 py-2 text-sm" placeholder="Custom cycle"></div>
                        </div>
                    </div>

                    <!-- Meta Data -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                             <label class="block text-xs font-medium text-gray-500 mb-1">TYPE</label>
                             <select id="tipeProduk" class="glass-input w-full px-3 py-2 text-sm">
                                <option value="">Select Type...</option>
                                <option value="eBook">eBook</option>
                                <option value="Web App">Web App</option>
                                <option value="Course">Course</option>
                                <option value="Lainnya">Custom</option>
                            </select>
                            <div id="tipeProdukLainnyaContainer" class="hidden mt-2 input-wrapper"><input type="text" id="tipeProdukLainnya" class="glass-input w-full px-3 py-2 text-sm" placeholder="Custom type"></div>
                        </div>
                        <div>
                             <label class="block text-xs font-medium text-gray-500 mb-1">EMAIL</label>
                             <select id="emailSelect" class="glass-input w-full px-3 py-2 text-sm">
                                <option value="">Select Email...</option>
                                <option value="eunoiamahbara@gmail.com">eunoiamahbara...</option>
                                <option value="ikmalogic@gmail.com">ikmalogic...</option>
                                <option value="ikmal@fahimna.my.id">ikmal@fahimna...</option>
                                <option value="Lainnya">Custom</option>
                            </select>
                            <div id="emailLainnyaContainer" class="hidden mt-2 input-wrapper"><input type="email" id="emailLainnyaInput" class="glass-input w-full px-3 py-2 text-sm" placeholder="Custom email"></div>
                        </div>
                    </div>

                    <!-- Account Info -->
                    <div class="p-4 rounded-xl bg-white/5 border border-white/5 space-y-3">
                         <div class="flex items-center gap-2 mb-2">
                             <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                             <span class="text-xs font-bold text-gray-400 tracking-wider">CREDENTIALS</span>
                         </div>
                         <div class="input-wrapper"><input type="text" id="akun" class="glass-input w-full px-3 py-2 text-sm bg-black/40" placeholder="Username/ID"></div>
                         <div class="input-wrapper relative">
                             <input type="password" id="password" class="glass-input w-full px-3 py-2 text-sm bg-black/40 pr-10" placeholder="Password">
                             <button type="button" class="btn-toggle-password absolute right-2 top-2 text-gray-500 hover:text-white"><svg class="w-5 h-5 toggle-pass-icon-show" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button>
                         </div>
                    </div>

                    <!-- Other Hidden/Less important fields for Gemini Aesthetic cleanliness -->
                    <div class="hidden">
                        <input type="text" id="ownerProduk" value="">
                        <textarea id="linkAkses"></textarea>
                        <textarea id="catatan"></textarea>
                        <input type="number" id="hargaBeli-hidden"> <!-- Fallback -->
                    </div>

                    <!-- Expandable Details -->
                    <details class="group bg-white/5 rounded-xl border border-white/5">
                        <summary class="flex cursor-pointer items-center justify-between p-4 font-medium text-gray-400 hover:text-white transition-colors">
                            <span class="text-xs font-bold tracking-wider">EXTRA DETAILS</span>
                            <span class="transition group-open:rotate-180"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></span>
                        </summary>
                        <div class="p-4 pt-0 space-y-3 text-sm animate-fade-in">
                            <div><label class="block text-xs text-gray-500 mb-1">Seller/Owner</label><input type="text" id="ownerProduk-visible" class="glass-input w-full px-3 py-2 text-sm"></div>
                            <div><label class="block text-xs text-gray-500 mb-1">Access Links (One per line)</label><textarea id="linkAkses-visible" rows="3" class="glass-input w-full px-3 py-2 text-sm"></textarea></div>
                            <div><label class="block text-xs text-gray-500 mb-1">Notes</label><textarea id="catatan-visible" rows="2" class="glass-input w-full px-3 py-2 text-sm"></textarea></div>
                        </div>
                    </details>
                </div>

                <div class="flex gap-3 pt-4 border-t border-white/10">
                    <button type="button" id="modal-cancel-btn" class="flex-1 btn-gemini-secondary py-2.5 text-sm">Cancel</button>
                    <button type="submit" id="modal-save-btn" class="flex-1 btn-gemini-primary py-2.5 text-sm shadow-blue-500/20">Save Entry</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-delete-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden">
        <div class="glass-panel w-full max-w-sm p-6 rounded-2xl text-center border border-red-500/20 shadow-2xl">
            <div class="w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </div>
            <h3 class="text-lg font-bold text-white mb-2">Delete Entry?</h3>
            <p class="text-gray-400 text-sm mb-6">Are you sure you want to delete <strong id="product-name-to-delete" class="text-white"></strong>? This action cannot be undone.</p>
            <div class="flex justify-center gap-3">
                <button type="button" id="cancel-delete-btn" class="px-5 py-2.5 rounded-xl bg-white/5 hover:bg-white/10 text-gray-300 transition-colors text-sm">Cancel</button>
                <button type="button" id="confirm-delete-btn" class="px-5 py-2.5 rounded-xl bg-red-500 hover:bg-red-600 text-white shadow-lg shadow-red-500/30 transition-colors text-sm font-medium">Yes, Delete</button>
            </div>
        </div>
    </div>

    <!-- Link Modal & Password Modal (Simplified Re-use structure for brevity, logic handles IDs) -->
    <!-- Link Modal -->
    <div id="link-form-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden">
        <div class="glass-panel w-full max-w-md p-6 rounded-3xl border border-white/10 bg-[#0B101B]">
            <form id="link-form" class="space-y-4">
                <h2 id="link-modal-title" class="text-lg font-bold text-white mb-4">New Tool</h2>
                <div id="link-modal-error" class="hidden text-red-400 text-xs"></div>
                <input type="hidden" id="link-id">
                <input type="text" id="link-nama" class="glass-input w-full px-4 py-3" placeholder="Tool Name (e.g. Figma)" required>
                <input type="url" id="link-akses" class="glass-input w-full px-4 py-3" placeholder="https://..." required>
                <input type="text" id="link-tag" class="glass-input w-full px-4 py-3" placeholder="Tags (e.g. Design, AI)">
                <textarea id="link-catatan" class="glass-input w-full px-4 py-3" rows="2" placeholder="Notes"></textarea>
                <div class="flex gap-3 pt-2">
                    <button type="button" id="link-modal-cancel-btn" class="flex-1 btn-gemini-secondary py-2 text-sm">Cancel</button>
                    <button type="submit" id="link-modal-save-btn" class="flex-1 btn-gemini-primary py-2 text-sm bg-gradient-to-r from-yellow-500 to-orange-500">Save Tool</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-form-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden">
        <div class="glass-panel w-full max-w-md p-6 rounded-3xl border border-white/10 bg-[#0B101B]">
            <form id="password-form" class="space-y-4">
                <h2 id="password-modal-title" class="text-lg font-bold text-white mb-4">New Password</h2>
                <div id="password-modal-error" class="hidden text-red-400 text-xs"></div>
                <input type="hidden" id="password-id">
                <input type="text" id="password-nama" class="glass-input w-full px-4 py-3" placeholder="Site Name (e.g. Github)" required>
                <input type="text" id="password-username" class="glass-input w-full px-4 py-3" placeholder="Username/Email" required>
                <div class="relative">
                    <input type="password" id="password-password" class="glass-input w-full px-4 py-3 pr-10" placeholder="Password" required>
                    <button type="button" class="btn-toggle-password absolute right-3 top-3 text-gray-500 hover:text-white"><svg class="w-5 h-5 toggle-pass-icon-show" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button>
                </div>
                <textarea id="password-catatan" class="glass-input w-full px-4 py-3" rows="2" placeholder="Notes"></textarea>
                <div class="flex gap-3 pt-2">
                    <button type="button" id="password-modal-cancel-btn" class="flex-1 btn-gemini-secondary py-2 text-sm">Cancel</button>
                    <button type="submit" id="password-modal-save-btn" class="flex-1 btn-gemini-primary py-2 text-sm bg-gradient-to-r from-emerald-500 to-teal-500">Save Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Link/Pass Modals (Structure similar to main delete) -->
    <div id="confirm-delete-link-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm"><div class="glass-panel p-6 rounded-2xl text-center"><h3 class="text-white font-bold mb-4">Delete Tool?</h3><p id="link-name-to-delete" class="text-gray-400 mb-6"></p><div class="flex gap-2 justify-center"><button id="cancel-delete-link-btn" class="btn-gemini-secondary px-4 py-2">Cancel</button><button id="confirm-delete-link-btn" class="bg-red-500 text-white rounded-xl px-4 py-2 hover:bg-red-600">Delete</button></div></div></div>
    <div id="confirm-delete-password-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm"><div class="glass-panel p-6 rounded-2xl text-center"><h3 class="text-white font-bold mb-4">Delete Password?</h3><p id="password-name-to-delete" class="text-gray-400 mb-6"></p><div class="flex gap-2 justify-center"><button id="cancel-delete-password-btn" class="btn-gemini-secondary px-4 py-2">Cancel</button><button id="confirm-delete-password-btn" class="bg-red-500 text-white rounded-xl px-4 py-2 hover:bg-red-600">Delete</button></div></div></div>


    <!-- ================= SCRIPT ================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Init ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config !== "") ? JSON.parse(__firebase_config) : { apiKey: "", authDomain: "", projectId: "" }; // Fallback handling
        
        let db, auth, userId;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch(e) { console.log("Firebase not init (local/template mode)"); }

        // --- Variables ---
        let allProducts = [], allLinks = [], allPasswords = []; 
        let currentView = 'my-purchase';
        let isCardViewCollapsed = false;
        let productToDeleteId = null, linkToDeleteId = null, passwordToDeleteId = null;
        let unsubscribeFromProducts, unsubscribeFromLinks, unsubscribeFromPasswords;

        // --- UI Logic Wrappers ---
        const getEl = (id) => document.getElementById(id);
        
        function updateMainView(newView) {
            currentView = newView;
            document.querySelectorAll('.active-menu-item').forEach(el => {
                el.classList.remove('active-menu-item', 'bg-white/5', 'text-blue-300');
                el.classList.add('text-gray-400');
            });
            const activeBtn = document.querySelector(`button[data-action="${newView}"]`);
            if(activeBtn) activeBtn.classList.add('active-menu-item', 'bg-white/5', 'text-blue-300', 'text-white');

            // Hide All
            ['product-content', 'password-content', 'link-content'].forEach(id => getEl(id).classList.add('hidden'));
            ['add-product-btn-wrapper', 'add-link-btn-wrapper', 'add-password-btn-wrapper'].forEach(id => getEl(id).classList.add('hidden'));

            // Show Specific
            if (newView === 'my-purchase') {
                getEl('page-title').innerHTML = `My <span class="text-blue-400">Purchase</span>`;
                getEl('product-content').classList.remove('hidden');
                getEl('add-product-btn-wrapper').classList.remove('hidden');
                renderFilteredProducts();
            } else if (newView === 'my-subscribe') {
                getEl('page-title').innerHTML = `My <span class="text-purple-400">Subscribe</span>`;
                getEl('product-content').classList.remove('hidden');
                getEl('add-product-btn-wrapper').classList.remove('hidden');
                renderFilteredProducts();
            } else if (newView === 'my-password') {
                getEl('page-title').innerHTML = `My <span class="text-emerald-400">Vault</span>`;
                getEl('password-content').classList.remove('hidden');
                getEl('add-password-btn-wrapper').classList.remove('hidden');
                renderFilteredPasswords();
            } else if (newView === 'my-link') {
                getEl('page-title').innerHTML = `My <span class="text-yellow-400">Tools</span>`;
                getEl('link-content').classList.remove('hidden');
                getEl('add-link-btn-wrapper').classList.remove('hidden');
                renderFilteredLinks();
            }
        }

        // --- Render Logic (Gemini Style Cards) ---
        function createProductCard(p, compact = false) {
            const div = document.createElement('div');
            div.className = `glass-panel rounded-2xl overflow-hidden transition-all duration-300 hover:shadow-2xl hover:border-blue-500/30 group ${compact ? 'p-4 flex items-center justify-between cursor-pointer compact-card-clickable' : 'p-0 manually-opened'}`;
            div.dataset.id = p.id;

            const sanitize = (str) => { const d = document.createElement('div'); d.textContent = str || ''; return d.innerHTML; };
            const dateStr = p.tanggalMulai || p.tanggalBeli ? new Date(p.tanggalMulai || p.tanggalBeli).toLocaleDateString('id-ID', {day:'numeric', month:'short', year:'numeric'}) : '-';
            const priceStr = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(p.hargaBeli || p.hargaLangganan || 0);

            if (compact) {
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br ${p.tipeTransaksi === 'subscribe' ? 'from-purple-500/20 to-purple-900/20 text-purple-400' : 'from-blue-500/20 to-blue-900/20 text-blue-400'} flex items-center justify-center border border-white/5">
                            <span class="font-bold text-xs">${p.tipeTransaksi === 'subscribe' ? 'SUB' : 'BUY'}</span>
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-sm">${sanitize(p.namaProduk)}</h3>
                            <p class="text-xs text-gray-500">${dateStr}</p>
                        </div>
                    </div>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                         <button class="p-2 text-gray-400 hover:text-white btn-edit"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                         <button class="p-2 text-gray-400 hover:text-red-400 btn-delete" data-name="${sanitize(p.namaProduk)}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>
                `;
            } else {
                // Full Card Gemini Style
                const badgeColor = p.tipeTransaksi === 'subscribe' ? 'bg-purple-500/10 text-purple-400 border-purple-500/20' : 'bg-blue-500/10 text-blue-400 border-blue-500/20';
                
                div.innerHTML = `
                    <div class="p-5 relative">
                        <!-- Header -->
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex gap-3">
                                <div class="w-12 h-12 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-xl">
                                    ${p.tipeProduk === 'Course' ? 'üéì' : p.tipeProduk === 'eBook' ? 'üìö' : 'üì¶'}
                                </div>
                                <div>
                                    <h3 class="text-lg font-display font-bold text-white leading-tight">${sanitize(p.namaProduk)}</h3>
                                    <p class="text-xs text-gray-500 mt-1">${sanitize(p.ownerProduk) || 'Unknown Creator'}</p>
                                </div>
                            </div>
                            <span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase tracking-wide border ${badgeColor}">${p.tipeTransaksi}</span>
                        </div>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <div class="p-3 rounded-lg bg-black/20 border border-white/5">
                                <p class="text-[10px] text-gray-500 uppercase font-bold">Price</p>
                                <p class="text-sm font-mono text-white">${priceStr}</p>
                            </div>
                            <div class="p-3 rounded-lg bg-black/20 border border-white/5">
                                <p class="text-[10px] text-gray-500 uppercase font-bold">${p.tipeTransaksi === 'subscribe' ? 'Cycle' : 'Date'}</p>
                                <p class="text-sm font-mono text-white">${p.tipeTransaksi === 'subscribe' ? (p.periodeLangganan || '-') : dateStr}</p>
                            </div>
                        </div>

                        <!-- Account Section (if exists) -->
                        ${(p.akun || p.password) ? `
                        <div class="mb-4 p-3 rounded-lg bg-blue-500/5 border border-blue-500/10">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-[10px] text-blue-400 font-bold uppercase">Credential</span>
                                <button class="btn-toggle-password text-gray-400 hover:text-white"><svg class="w-4 h-4 toggle-pass-icon-show" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button>
                            </div>
                            <div class="text-xs text-gray-300 truncate font-mono">${sanitize(p.akun)}</div>
                            <div class="password-group-display relative mt-1">
                                <input type="password" value="${sanitize(p.password)}" class="bg-transparent text-xs text-gray-300 font-mono w-full focus:outline-none" readonly>
                            </div>
                        </div>` : ''}

                        <!-- Action Bar -->
                        <div class="flex items-center gap-2 pt-4 border-t border-white/5">
                            ${(p.linkAkses && p.linkAkses.length) ? 
                                `<a href="${Array.isArray(p.linkAkses) ? p.linkAkses[0] : p.linkAkses}" target="_blank" class="flex-1 btn-gemini-primary py-2 text-xs text-center shadow-lg shadow-blue-500/20">Access Now</a>` 
                                : '<button class="flex-1 py-2 text-xs text-gray-500 cursor-not-allowed bg-white/5 rounded-xl">No Link</button>'}
                            
                            <button class="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition-colors btn-edit"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                            <button class="p-2 rounded-xl bg-white/5 hover:bg-red-500/20 text-gray-400 hover:text-red-400 transition-colors btn-delete" data-name="${sanitize(p.namaProduk)}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    </div>
                `;
            }
            return div;
        }

        // --- Auth Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                getEl('auth-container').classList.add('hidden');
                getEl('main-content').classList.remove('hidden');
                getEl('user-info').classList.remove('hidden');
                getEl('user-email').textContent = user.isAnonymous ? "Guest Explorer" : user.email;
                
                loadProducts(); loadLinks(); loadPasswords();
                updateMainView('my-purchase');
            } else {
                userId = null;
                getEl('auth-container').classList.remove('hidden');
                getEl('main-content').classList.add('hidden');
                getEl('user-info').classList.add('hidden');
            }
        });

        // --- Filter Logic ---
        function renderFilteredProducts() {
            const list = getEl('product-list');
            list.innerHTML = '';
            
            const term = getEl('search-input').value.toLowerCase();
            const type = currentView === 'my-purchase' ? 'purchase' : 'subscribe';
            
            const filtered = allProducts.filter(p => {
                const matchType = p.tipeTransaksi === type || (type==='purchase' && !p.tipeTransaksi);
                const matchSearch = !term || JSON.stringify(p).toLowerCase().includes(term);
                return matchType && matchSearch;
            });

            if(filtered.length === 0) {
                getEl('empty-state').classList.remove('hidden');
            } else {
                getEl('empty-state').classList.add('hidden');
                list.className = isCardViewCollapsed ? "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" : "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";
                filtered.forEach(p => list.appendChild(createProductCard(p, isCardViewCollapsed)));
            }
        }
        
        // --- Gemini AI Logic (Gemini 2.0 Flash) ---
        async function handleGeminiRequest() {
            const name = getEl('namaProduk').value;
            const type = getEl('tipeProduk').value || 'Digital Product';
            const container = getEl('gemini-response-container');
            const loader = getEl('gemini-loading');
            
            if(!name) { alert("Please enter a product name first."); return; }
            
            container.classList.add('hidden');
            loader.classList.remove('hidden');
            
            const apiKey = ""; // API Key injected by environment
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const prompt = `Produk digital: "${name}" (${type}). Berikan 3 tips singkat memaksimalkan produk ini & 1 ide fitur tambahan. Format poin-poin. Gaya bahasa santai, to the point.`;
            
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "AI diam seribu bahasa.";
                
                container.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong class="text-blue-300">$1</strong>');
                container.classList.remove('hidden');
            } catch(e) {
                console.error(e);
                container.innerHTML = "Gagal menghubungi Gemini.";
                container.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        }

        // --- Core CRUD (Abbreviated to fit logic) ---
        function getCollectionPath(col) { return userId ? `/artifacts/${appId}/users/${userId}/${col}` : null; }
        
        async function loadProducts() {
            if(unsubscribeFromProducts) unsubscribeFromProducts();
            const path = getCollectionPath('products'); if(!path) return;
            getEl('loading-state').classList.remove('hidden');
            
            unsubscribeFromProducts = onSnapshot(collection(db, path), (snap) => {
                allProducts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                allProducts.sort((a,b) => new Date(b.tanggalBeli || b.tanggalMulai) - new Date(a.tanggalBeli || a.tanggalMulai));
                getEl('loading-state').classList.add('hidden');
                renderFilteredProducts();
            });
        }
        
        // ... (Similar load functions for Links/Passwords omitted for brevity but logic exists in listeners below) ...
        async function loadLinks() {
             const path = getCollectionPath('links'); if(!path) return;
             onSnapshot(collection(db, path), (snap) => {
                 allLinks = snap.docs.map(d => ({id:d.id, ...d.data()}));
                 renderFilteredLinks();
             });
        }
        
        async function loadPasswords() {
             const path = getCollectionPath('passwords'); if(!path) return;
             onSnapshot(collection(db, path), (snap) => {
                 allPasswords = snap.docs.map(d => ({id:d.id, ...d.data()}));
                 renderFilteredPasswords();
             });
        }
        
        function renderFilteredLinks() {
            if(currentView !== 'my-link') return;
            const list = getEl('link-list'); list.innerHTML = '';
            const term = getEl('search-input').value.toLowerCase();
            const filtered = allLinks.filter(l => !term || JSON.stringify(l).toLowerCase().includes(term));
            
            filtered.forEach(l => {
                const div = document.createElement('div');
                div.className = "glass-panel p-4 flex items-center justify-between group rounded-xl hover:border-yellow-500/30 transition-all";
                div.innerHTML = `
                    <div class="flex items-center gap-4 overflow-hidden">
                        <div class="w-10 h-10 rounded-lg bg-yellow-500/10 flex items-center justify-center text-yellow-500 text-lg border border-yellow-500/20">üõ†Ô∏è</div>
                        <div class="min-w-0">
                            <h3 class="font-bold text-white text-sm truncate">${l.namaTools}</h3>
                            <a href="${l.linkAkses}" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 truncate block">${l.linkAkses}</a>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn-edit-link p-2 text-gray-400 hover:text-white" data-id="${l.id}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                        <button class="btn-delete-link p-2 text-gray-400 hover:text-red-400" data-id="${l.id}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>`;
                list.appendChild(div);
            });
        }
        
        function renderFilteredPasswords() {
            if(currentView !== 'my-password') return;
            const list = getEl('password-list'); list.innerHTML = '';
            const term = getEl('search-input').value.toLowerCase();
            const filtered = allPasswords.filter(p => !term || JSON.stringify(p).toLowerCase().includes(term));
            
            filtered.forEach(p => {
                const div = document.createElement('div');
                div.className = "glass-panel p-4 rounded-xl hover:border-emerald-500/30 transition-all";
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-white">${p.namaSitus}</h3>
                        <div class="flex gap-2">
                             <button class="btn-edit-password text-gray-400 hover:text-white" data-id="${p.id}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                             <button class="btn-delete-password text-gray-400 hover:text-red-400" data-id="${p.id}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400 mb-2">${p.username}</div>
                    <div class="relative password-group-display bg-black/30 rounded p-2 flex justify-between">
                         <input type="password" value="${p.password}" class="bg-transparent text-sm text-emerald-400 font-mono focus:outline-none w-full" readonly>
                         <button class="btn-toggle-password text-gray-400 hover:text-white"><svg class="w-4 h-4 toggle-pass-icon-show" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // --- Event Listeners (UI Interactions) ---
        getEl('sidebar-toggle-btn').onclick = () => { getEl('sidebar').classList.remove('-translate-x-full'); getEl('sidebar-overlay').classList.remove('hidden', 'opacity-0'); };
        const closeSidebar = () => { getEl('sidebar').classList.add('-translate-x-full'); getEl('sidebar-overlay').classList.add('opacity-0'); setTimeout(()=>getEl('sidebar-overlay').classList.add('hidden'), 300); };
        getEl('sidebar-close-btn').onclick = closeSidebar;
        getEl('sidebar-overlay').onclick = closeSidebar;
        
        getEl('sidebar-menu-list').onclick = (e) => {
            const btn = e.target.closest('button[data-action]');
            if(btn) { updateMainView(btn.dataset.action); closeSidebar(); }
        };
        
        getEl('login-form').onsubmit = async (e) => { e.preventDefault(); await signInWithEmailAndPassword(auth, getEl('login-email').value, getEl('login-password').value); };
        getEl('logout-btn').onclick = () => signOut(auth);
        getEl('anonymous-login-btn').onclick = () => signInAnonymously(auth);
        
        // Show/Hide Modals
        const toggleModal = (id, show) => getEl(id).classList.toggle('hidden', !show);
        getEl('add-product-btn').onclick = () => { getEl('product-form').reset(); getEl('product-id').value=''; toggleModal('form-modal', true); };
        getEl('add-link-btn').onclick = () => { getEl('link-form').reset(); getEl('link-id').value=''; toggleModal('link-form-modal', true); };
        getEl('add-password-btn').onclick = () => { getEl('password-form').reset(); getEl('password-id').value=''; toggleModal('password-form-modal', true); };
        
        getEl('modal-close-btn').onclick = () => toggleModal('form-modal', false);
        getEl('modal-cancel-btn').onclick = () => toggleModal('form-modal', false);
        getEl('link-modal-cancel-btn').onclick = () => toggleModal('link-form-modal', false);
        getEl('password-modal-cancel-btn').onclick = () => toggleModal('password-form-modal', false);
        
        // Form Saves
        getEl('product-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = getEl('product-id').value;
            const type = document.querySelector('input[name="modal_type_transaksi"]:checked')?.value || 'purchase';
            
            // Map values simply
            const data = {
                namaProduk: getEl('namaProduk').value,
                tipeTransaksi: type,
                tipeProduk: getEl('tipeProduk').value === 'Lainnya' ? getEl('tipeProdukLainnya').value : getEl('tipeProduk').value,
                tanggalBeli: getEl('tanggalBeli').value,
                hargaBeli: getEl('hargaBeli').value,
                tanggalMulai: getEl('tanggalMulai').value,
                hargaLangganan: getEl('hargaLangganan').value,
                periodeLangganan: getEl('periodeLangganan').value === 'Lainnya' ? getEl('periodeLanggananLainnya').value : getEl('periodeLangganan').value,
                akun: getEl('akun').value,
                password: getEl('password').value,
                linkAkses: getEl('linkAkses-visible').value.split('\n'),
                ownerProduk: getEl('ownerProduk-visible').value,
                catatan: getEl('catatan-visible').value
            };
            
            const path = getCollectionPath('products');
            if(id) await setDoc(doc(db, path, id), data); else await addDoc(collection(db, path), data);
            toggleModal('form-modal', false);
        };
        
        getEl('link-form').onsubmit = async (e) => {
             e.preventDefault();
             const id = getEl('link-id').value;
             const data = { namaTools: getEl('link-nama').value, linkAkses: getEl('link-akses').value, tags: getEl('link-tag').value, catatan: getEl('link-catatan').value };
             const path = getCollectionPath('links');
             if(id) await setDoc(doc(db, path, id), data); else await addDoc(collection(db, path), data);
             toggleModal('link-form-modal', false);
        };
        
        getEl('password-form').onsubmit = async (e) => {
             e.preventDefault();
             const id = getEl('password-id').value;
             const data = { namaSitus: getEl('password-nama').value, username: getEl('password-username').value, password: getEl('password-password').value, catatan: getEl('password-catatan').value };
             const path = getCollectionPath('passwords');
             if(id) await setDoc(doc(db, path, id), data); else await addDoc(collection(db, path), data);
             toggleModal('password-form-modal', false);
        };

        // Edit/Delete Delegation
        document.body.addEventListener('click', async (e) => {
            // Edit Product
            const editBtn = e.target.closest('.btn-edit');
            if(editBtn) {
                const id = editBtn.closest('[data-id]').dataset.id;
                const snap = await getDoc(doc(db, getCollectionPath('products'), id));
                const d = snap.data();
                
                getEl('product-id').value = id;
                getEl('namaProduk').value = d.namaProduk;
                document.querySelector(`input[value="${d.tipeTransaksi}"]`).click();
                
                // Populate visible details
                getEl('ownerProduk-visible').value = d.ownerProduk || '';
                getEl('linkAkses-visible').value = Array.isArray(d.linkAkses) ? d.linkAkses.join('\n') : (d.linkAkses || '');
                getEl('catatan-visible').value = d.catatan || '';
                
                getEl('akun').value = d.akun || '';
                getEl('password').value = d.password || '';
                
                toggleModal('form-modal', true);
            }
            
            // Delete Product
            const delBtn = e.target.closest('.btn-delete');
            if(delBtn) {
                 productToDeleteId = delBtn.closest('[data-id]').dataset.id;
                 getEl('product-name-to-delete').textContent = delBtn.dataset.name;
                 getEl('confirm-delete-modal').classList.remove('hidden');
            }
            
            // Toggle Password
            const togglePass = e.target.closest('.btn-toggle-password');
            if(togglePass) {
                e.preventDefault();
                const input = togglePass.closest('div').querySelector('input');
                input.type = input.type === 'password' ? 'text' : 'password';
            }

            // Gemini Call
            if(e.target.closest('#gemini-info-btn')) {
                handleGeminiRequest();
            }
        });
        
        getEl('confirm-delete-btn').onclick = async () => {
             await deleteDoc(doc(db, getCollectionPath('products'), productToDeleteId));
             getEl('confirm-delete-modal').classList.add('hidden');
        };
        getEl('cancel-delete-btn').onclick = () => getEl('confirm-delete-modal').classList.add('hidden');

        // Handling Type Toggle in Modal
        document.querySelectorAll('input[name="modal_type_transaksi"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if(e.target.value === 'purchase') {
                    getEl('purchase-fields').classList.remove('hidden');
                    getEl('subscribe-fields').classList.add('hidden');
                } else {
                    getEl('purchase-fields').classList.add('hidden');
                    getEl('subscribe-fields').classList.remove('hidden');
                }
            });
        });
        
        getEl('search-input').addEventListener('input', () => {
             if(currentView === 'my-purchase' || currentView === 'my-subscribe') renderFilteredProducts();
             if(currentView === 'my-link') renderFilteredLinks();
             if(currentView === 'my-password') renderFilteredPasswords();
        });
        
        getEl('card-toggle-switch').onclick = () => {
            isCardViewCollapsed = !isCardViewCollapsed;
            const handle = getEl('card-toggle-handle');
            if(isCardViewCollapsed) {
                handle.classList.add('translate-x-5'); getEl('card-toggle-switch').classList.add('bg-blue-600');
            } else {
                handle.classList.remove('translate-x-5'); getEl('card-toggle-switch').classList.remove('bg-blue-600');
            }
            renderFilteredProducts(); // Re-render to apply class changes
        };

    </script>
</body>
</html>
